tinymce.PluginManager.add('universaldrive', function(editor, url) {
    editor.ui.registry.addMenuItem('googledriveopen', {
        text: 'Google Drive',
        onAction: function() {
            openDrivePicker('google', 'open');
        }
    });
    
    editor.ui.registry.addMenuItem('onedriveopen', {
        text: 'OneDrive',
        onAction: function() {
            openDrivePicker('onedrive', 'open');
        }
    });
    
    editor.ui.registry.addMenuItem('googledrivesave', {
        text: 'Google Drive',
        onAction: function() {
            openDrivePicker('google', 'save');
        }
    });
    
    editor.ui.registry.addMenuItem('onedrivesave', {
        text: 'OneDrive',
        onAction: function() {
            openDrivePicker('onedrive', 'save');
        }
    });
	async function openDrivePicker(provider, mode) {
		let pickerLoaded = false;
		
		// Use the global authentication system
		const authenticated = await window.requireCloudAuth(provider, function(provider) {
		    // This callback runs after successful authentication
		    showFileSelectionDialog(provider, mode);
		    pickerLoaded = true;
		});
		
		// If already authenticated and callback didn't load the picker, load it now
		if (authenticated && !pickerLoaded) {
		    showFileSelectionDialog(window.cloudProviders[provider], mode);
		}
	}

	function showFileSelectionDialog(provider, mode) {
		// Clean up any previous dialog state
		if (window.selectDriveFileToOpen) {
		    delete window.selectDriveFileToOpen;
		}
		if (window.openDriveFolderInOpenDialog) {
		    delete window.openDriveFolderInOpenDialog;
		}
		if (window.navigateToDriveBreadcrumbInOpen) {
		    delete window.navigateToDriveBreadcrumbInOpen;
		}

		// Initialize folder navigation
		let currentFolderId = 'root';
		let selectedFolderId = 'root';
		let selectedFile = null;
		let folderStack = [{id: 'root', name: 'My Drive'}];
		let dialogInstance = null;
		
		// Build file type options dynamically
		const fileTypeOptions = window.getSelectOptions()
		    .map(opt => `<option value="${opt.value}">${opt.text}</option>`)
		    .join('');
		    
		const dialogConfig = {
		    title: `${mode === 'save' ? 'Save to' : 'Open from'} ${provider.name}`,
		    size: 'medium',
			body: {
				type: 'panel',
				items: [
					{
						type: 'htmlpanel',
						html: `
						    <div id="onedrive-open-dialog-container" style="min-height: 400px !important;">
						        <div id="onedrive-open-breadcrumb" style="padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-size: 13px;">
						            <span>‚òÅÔ∏è My ${provider.name}</span>
						        </div>
						        <div id="onedrive-open-item-list" style="padding: 10px; max-height: 400px; overflow-y: auto;">
						            <div style="text-align: center; padding: 20px; color: #666;">
						                Loading...
						            </div>
						        </div>
						        ${mode === 'save' ? 
						            '<div style="padding: 15px; background: #f9f9f9;">' +
						                '<div style="display: flex; align-items: center; margin-bottom: 10px;">' +
						                    '<label for="onedrive-filename" style="width: 90px; font-weight: bold;">File Name:</label>' +
						                    '<input type="text" id="onedrive-filename" value="Untitled" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">' +
						                '</div>' +
						                '<div style="display: flex; align-items: center;">' +
						                    '<label for="onedrive-extension" style="width: 90px; font-weight: bold;">File type:</label>' +
						                    '<select id="onedrive-extension" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">' +
						                        fileTypeOptions +
						                    '</select>' +
						                '</div>' +
						            '</div>'
						        : ''}
						    </div>
						`
					}
				]
			},	
		    buttons: [
                {
                    type: 'submit',
                    text: mode === 'save' ? 'Save' : 'Open',
                    primary: true,
                    name: 'save-button'
                },		    
		        {
		            type: 'cancel',
		            text: 'Cancel'
		        }
		    ],
            onSubmit: function(api) {         
            	if(mode === 'save')
            	{
            		performSave(provider, selectedFolderId, api);
            	}
                else
                {
					loadFileContent(selectedFile, provider);              	
                }
                dialogInstance.close();                   
            },	    
		    onClose: function() {
		        if (window.selectDriveFileToOpen) {
		            delete window.selectDriveFileToOpen;
		        }
		        if (window.openDriveFolderInOpenDialog) {
		            delete window.openDriveFolderInOpenDialog;
		        }
		        if (window.navigateToDriveBreadcrumbInOpen) {
		            delete window.navigateToDriveBreadcrumbInOpen;
		        }
		    }
		};

		dialogInstance = editor.windowManager.open(dialogConfig);
		if(mode === 'save')
		{
			dialogInstance.enable('save-button');
		}
		else
		{
			dialogInstance.disable('save-button');
		}
		// Load items after dialog opens
		setTimeout(() => {
		    if (dialogInstance) {
		        loadDriveItems(provider, currentFolderId);
		    }
		}, 100);

		// Helper function to load items (files and folders)
		async function loadDriveItems(provider, folderId) {
		    const itemListEl = document.getElementById('onedrive-open-item-list');
		    if (!itemListEl) return;

		    itemListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading...</div>';

		    try {
		    	let url;
		    	if (provider.name === 'Google Drive')
		    	{
					const query = folderId === 'root' 
						? "'root' in parents and trashed=false"
						: `'${folderId}' in parents and trashed=false`;

					url = 'https://www.googleapis.com/drive/v3/files?' + new URLSearchParams({
						q: query,
						fields: 'files(id,name,mimeType)',
						pageSize: 100
					});		    		
		    	}
		    	else if(provider.name === 'OneDrive')
		    	{
				    url = folderId === 'root' 
				        ? 'https://graph.microsoft.com/v1.0/me/drive/root/children'
				        : `https://graph.microsoft.com/v1.0/me/drive/items/${folderId}/children`;
				}
				else 
				{
				    editor.notificationManager.open({
				        text: 'Unkonwn Drive Provider:' + '${provider}',
				        type: 'error',
				        timeout: 5000
				    });
				    return;					
				}
		        const response = await fetch(url, {
		            headers: {
		                'Authorization': 'Bearer ' + provider.token
		            }
		        });

		        if (!response.ok) {
		            throw new Error('Failed to load items');
		        }

		        const data = await response.json();
		        renderItems(data.value || data.files || [], provider);

		    } catch (error) {
		        console.error('Error loading items:', error);
		        itemListEl.innerHTML = `<div style="text-align: center; padding: 20px; color: #ea4335;">Failed to load items: ${error.message}</div>`;
		    }
		}

		function renderItems(items, provider) {
			const itemListEl = document.getElementById('onedrive-open-item-list');
			if (!itemListEl) return;
			
			// Check provider and filter accordingly
			let folders, textFiles;
			
			if (provider.name === 'Google Drive') {
				// Google Drive filtering
				folders = items.filter(item => 
				    item.mimeType === 'application/vnd.google-apps.folder'
				);
				textFiles = items.filter(item => 
				    item.mimeType !== 'application/vnd.google-apps.folder' && (
				        item.name.endsWith('.txt') || 
				        item.name.endsWith('.html') || 
				        item.name.endsWith('.htm') ||
				        item.name.endsWith('.md') ||
				        item.name.endsWith('.json') ||
				        item.name.endsWith('.doc') ||
				        item.name.endsWith('.docx')
				    )
				);
			} else {
				// OneDrive filtering
				folders = items.filter(item => item.folder);
				textFiles = items.filter(item => 
				    item.file && (
				        item.name.endsWith('.txt') || 
				        item.name.endsWith('.html') || 
				        item.name.endsWith('.htm') ||
				        item.name.endsWith('.md') ||
				        item.name.endsWith('.json') ||
				        item.name.endsWith('.doc') ||
				        item.name.endsWith('.docx')
				    )
				);
			}
			
			if (folders.length === 0 && textFiles.length === 0) {
				itemListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No folders or supported files in this location</div>';
				return;
			}
			
			let html = '<div style="display: flex; flex-direction: column; gap: 5px;">';
			
			// Add folders first
			folders.forEach(folder => {
				html += `
					<div class="onedrive-item" data-id="${folder.id}" data-name="${escapeHtml(folder.name)}" data-is-folder="true"
						 style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"
						 onmouseover="if(!this.classList.contains('selected')) this.style.background='#f0f0f0'" 
						 onmouseout="if(!this.classList.contains('selected')) this.style.background='white'"
						 onclick="window.selectDriveFileToOpen(this,'${folder.id}', '${escapeHtml(folder.name)}')"				         
						 ondblclick="window.openDriveFolderInOpenDialog('${folder.id}', '${escapeHtml(folder.name)}')">
						<span style="font-size: 24px;">üìÅ</span>
						<div>
						    <div style="font-weight: 500; color: #333;">${escapeHtml(folder.name)}</div>
						    <div style="font-size: 11px; color: #666;">Folder</div>
						</div>
					</div>
				`;
			});

			// Add files
			textFiles.forEach(file => {
				html += `
					<div class="onedrive-item" data-id="${file.id}" data-name="${escapeHtml(file.name)}" data-is-folder="false"
						 style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"
						 onmouseover="if(!this.classList.contains('selected')) this.style.background='#f0f0f0'" 
						 onmouseout="if(!this.classList.contains('selected')) this.style.background='white'"
						 onclick="window.selectDriveFileToOpen(this,'${file.id}', '${escapeHtml(file.name)}')">
						<span style="font-size: 24px;">üìÑ</span>
						<div>
						    <div style="font-weight: 500; color: #333;">${escapeHtml(file.name)}</div>
						    <div style="font-size: 11px; color: #666;">${formatFileSize(file.size)}</div>
						</div>
					</div>
				`;
			});
			
			html += '</div>';
			itemListEl.innerHTML = html;
		}
		
        // Global function for selecting an item
        window.selectDriveFileToOpen = function(element, fileId, fileName) {
            document.querySelectorAll('.onedrive-item').forEach(el => {
                el.classList.remove('selected');
                el.style.background = 'white';
            });
            element.classList.add('selected');
            element.style.background = '#e3f2fd';
            
            const isFolder = element.dataset.isFolder === 'true';
            if (isFolder) {
                selectedFolderId = element.dataset.id;
                if(mode === 'open')
                {
		        	// disable if a folder is selected
		        	dialogInstance.disable('save-button');  
            	}              
            } else {
            	selectedFile = { id: fileId, name: fileName };
            	// enable if a file is selected
            	dialogInstance.enable('save-button');
            }
        };
        
		// Global function for double-click to open folder
		window.openDriveFolderInOpenDialog = function(folderId, folderName) {
		    currentFolderId = folderId;
		    folderStack.push({id: folderId, name: folderName});
		    updateBreadcrumb();
		    loadDriveItems(provider, folderId);
		};

		function updateBreadcrumb() {
		    const breadcrumbEl = document.getElementById('onedrive-open-breadcrumb');
		    if (!breadcrumbEl) return;

		    let html = '<span>‚òÅÔ∏è</span> ';
		    folderStack.forEach((folder, index) => {
		        if (index > 0) html += ' / ';
		        html += `<a href="#" onclick="window.navigateToDriveBreadcrumbInOpen(${index}); return false;" style="color: #0078d4; text-decoration: none;">${escapeHtml(folder.name)}</a>`;
		    });

		    breadcrumbEl.innerHTML = html;
		}

		window.navigateToDriveBreadcrumbInOpen = function(index) {
		    folderStack = folderStack.slice(0, index + 1);
		    currentFolderId = folderStack[index].id;
		    updateBreadcrumb();
		    loadDriveItems(provider, currentFolderId);
		};
	}

    async function performSave(provider, folderId, dialogApi) {
        const fileName = document.getElementById('onedrive-filename').value.trim();
        const extension = document.getElementById('onedrive-extension').value;

        if (!fileName) {
            editor.notificationManager.open({
                text: 'Please enter a file name',
                type: 'error',
                timeout: 3000
            });
            return;
        }

        const fullFileName = fileName + extension;
        const htmlContent = editor.getContent();

        dialogApi.close();

        try {
            // Convert content
            const content = await window.fileConverter.convert(htmlContent, extension);
            
            // Create blob
            let blob;
            if (content instanceof Blob) {
                blob = content;
            } else {
                blob = new Blob([content], { type: window.getMimeType(extension) });
            }
			
			let response;

			if (provider.name === 'Google Drive') {
				// Google Drive multipart upload
				const metadata = {
					name: fullFileName,
					parents: [folderId]
				};
				
				const formData = new FormData();
				formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
				formData.append('file', blob);
				
				response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
					method: 'POST',
					headers: {
						'Authorization': 'Bearer ' + provider.token
					},
					body: formData
				});
			}
			else if (provider.name === 'OneDrive') {
				// OneDrive simple upload
				const uploadUrl = folderId === 'root'
					? `https://graph.microsoft.com/v1.0/me/drive/root:/${fullFileName}:/content`
					: `https://graph.microsoft.com/v1.0/me/drive/items/${folderId}:/${fullFileName}:/content`;
				
				response = await fetch(uploadUrl, {
					method: 'PUT',
					headers: {
						'Authorization': 'Bearer ' + provider.token,
						'Content-Type': window.getMimeType(extension)
					},
					body: blob
				});
			}
			else {
				editor.notificationManager.open({
					text: `Unknown Drive Provider: ${provider.name}`,
					type: 'error',
					timeout: 5000
				});
				return;
			}

			if (!response.ok) {
				throw new Error('Upload failed');
			}

            if (response.ok) {
                const result = await response.json();
                
                window.currentOneDriveFile = {
                    id: result.id,
                    name: fullFileName
                };

                editor.notificationManager.open({
                    text: '‚úÖ Saved: ' + fullFileName,
                    type: 'success',
                    timeout: 3000
                });
            } else {
                const error = await response.json();
                throw new Error(error.error.message || 'Unknown error');
            }

        } catch (error) {
            console.error('Error saving file:', error);
            editor.notificationManager.open({
                text: 'Failed to save: ' + error.message,
                type: 'error',
                timeout: 5000
            });
        }
    }
    
    async function loadFileContent(file, provider) {
        try {
        	let url;
            // Get download URL
            if (provider.name === 'Google Drive')
            {
            	url = `https://www.googleapis.com/drive/v3/files/${file.id}?alt=media`;
            }
            else if (provider.name === 'OneDrive')
            {
            	url = `https://graph.microsoft.com/v1.0/me/drive/items/${file.id}/content`;
            }
            const response = await fetch(url, {
                headers: {
                    'Authorization': 'Bearer ' + provider.token
                }
            });

            if (!response.ok) {
                throw new Error('Failed to download file');
            }

			const extension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
		    // Convert to HTML based on file type
		    if (extension === '.html') {
		    	const content = await response.text();
		    	editor.setContent(content);
		    } else {
				if (extension === '.docx') {
				    // For binary files, pass the blob
				    const blob = await response.blob();
				    htmlContent = await window.fileConverter.convertToHtml(blob, extension);
				} else {
				    // For text files, read as text first
				    const content = await response.text();
				    htmlContent = await window.fileConverter.convertToHtml(content, extension);
				}
				
				// Recalculate pages
				setTimeout(() => {
				    if (window.reapplyPageView) {
				        window.reapplyPageView(htmlContent);
				    }
				}, 100);		    
		    }			
            
            window.currentDriveFile = {
                id: file.id,
                name: file.name
            };

            editor.notificationManager.open({
                text: 'Opened: ' + file.name,
                type: 'success',
                timeout: 3000
            });

        } catch (error) {
            console.error('Error loading file:', error);
            editor.notificationManager.open({
                text: 'Failed to open file: ' + error.message,
                type: 'error',
                timeout: 5000
            });
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    return {
        getMetadata: function() {
            return {
                name: 'Open your Drive',
                url: 'http://yoursite.com'
            };
        }
    };
});
