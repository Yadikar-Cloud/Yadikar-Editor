tinymce.PluginManager.add("universaldrive",function(e,t){async function n(e,t){let n=!1;const o=await window.requireCloudAuth(e,function(e){i(e,t),n=!0});o&&!n&&i(window.cloudProviders[e],t)}function i(t,n){window.selectDriveFileToOpen&&delete window.selectDriveFileToOpen,window.openDriveFolderInOpenDialog&&delete window.openDriveFolderInOpenDialog,window.navigateToDriveBreadcrumbInOpen&&delete window.navigateToDriveBreadcrumbInOpen;let i="root",a="root",r=null,d=[{id:"root",name:"My Drive"}],s=null;const l=window.getSelectOptions().map(e=>`<option value="${e.value}">${e.text}</option>`).join(""),c={title:`${"save"===n?"Save to":"Open from"} ${t.name}`,size:"medium",body:{type:"panel",items:[{type:"htmlpanel",html:`\n\t\t\t\t\t\t    <div id="onedrive-open-dialog-container" style="min-height: 400px !important;">\n\t\t\t\t\t\t        <div id="onedrive-open-breadcrumb" style="padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-size: 13px;">\n\t\t\t\t\t\t            <span>‚òÅÔ∏è My ${t.name}</span>\n\t\t\t\t\t\t        </div>\n\t\t\t\t\t\t        <div id="onedrive-open-item-list" style="padding: 10px; max-height: 400px; overflow-y: auto;">\n\t\t\t\t\t\t            <div style="text-align: center; padding: 20px; color: #666;">\n\t\t\t\t\t\t                Loading...\n\t\t\t\t\t\t            </div>\n\t\t\t\t\t\t        </div>\n\t\t\t\t\t\t        ${"save"===n?'<div style="padding: 15px; background: #f9f9f9;"><div style="display: flex; align-items: center; margin-bottom: 10px;"><label for="onedrive-filename" style="width: 90px; font-weight: bold;">File Name:</label><input type="text" id="onedrive-filename" value="Untitled" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></div><div style="display: flex; align-items: center;"><label for="onedrive-extension" style="width: 90px; font-weight: bold;">File type:</label><select id="onedrive-extension" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">'+l+"</select></div></div>":""}\n\t\t\t\t\t\t    </div>\n\t\t\t\t\t\t`}]},buttons:[{type:"cancel",text:"Cancel"},{type:"submit",text:"save"===n?"Save":"Open",primary:!0,name:"save-button"}],onSubmit:async function(i){i.block("Processing..."),e.setProgressState(!0);try{"save"===n?await async function(t,n,i){const o=document.getElementById("onedrive-filename").value.trim(),a=document.getElementById("onedrive-extension").value;if(!o)return void e.notificationManager.open({text:"Please enter a file name",type:"error",timeout:3e3});const r=o+a,d=e.getContent();i.close();try{const i=await window.fileConverter.convert(d,a);let o,s;if(o=i instanceof Blob?i:new Blob([i],{type:window.getMimeType(a)}),"Google Drive"===t.name){const e={name:r,parents:[n]},i=new FormData;i.append("metadata",new Blob([JSON.stringify(e)],{type:"application/json"})),i.append("file",o),s=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:"Bearer "+t.token},body:i})}else{if("OneDrive"!==t.name)return void e.notificationManager.open({text:`Unknown Drive Provider: ${t.name}`,type:"error",timeout:5e3});{const e="root"===n?`https://graph.microsoft.com/v1.0/me/drive/root:/${r}:/content`:`https://graph.microsoft.com/v1.0/me/drive/items/${n}:/${r}:/content`;s=await fetch(e,{method:"PUT",headers:{Authorization:"Bearer "+t.token,"Content-Type":window.getMimeType(a)},body:o})}}if(!s.ok)throw new Error("Upload failed");if(!s.ok){const e=await s.json();throw new Error(e.error.message||"Unknown error")}{const t=await s.json();window.currentOneDriveFile={id:t.id,name:r},e.notificationManager.open({text:"‚úÖ Saved: "+r,type:"success",timeout:3e3})}}catch(t){console.error("Error saving file:",t),e.notificationManager.open({text:"Failed to save: "+t.message,type:"error",timeout:5e3})}}(t,a,i):await async function(t,n){try{let i;"Google Drive"===n.name?i=`https://www.googleapis.com/drive/v3/files/${t.id}?alt=media`:"OneDrive"===n.name&&(i=`https://graph.microsoft.com/v1.0/me/drive/items/${t.id}/content`);const o=await fetch(i,{headers:{Authorization:"Bearer "+n.token}});if(!o.ok)throw new Error("Failed to download file");const a=t.name.substring(t.name.lastIndexOf(".")).toLowerCase();if(".html"===a){const t=await o.text();e.setContent(t)}else{if(".docx"===a){const e=await o.blob();htmlContent=await window.fileConverter.convertToHtml(e,a)}else{const e=await o.text();htmlContent=await window.fileConverter.convertToHtml(e,a)}setTimeout(()=>{window.reapplyPageView&&window.reapplyPageView(htmlContent)},100)}window.currentDriveFile={id:t.id,name:t.name},e.notificationManager.open({text:"Opened: "+t.name,type:"success",timeout:3e3})}catch(t){console.error("Error loading file:",t),e.notificationManager.open({text:"Failed to open file: "+t.message,type:"error",timeout:5e3})}}(r,t),i.close()}catch(e){i.unblock(),console.error("Operation failed:",e)}finally{e.setProgressState(!1)}},onClose:function(){window.selectDriveFileToOpen&&delete window.selectDriveFileToOpen,window.openDriveFolderInOpenDialog&&delete window.openDriveFolderInOpenDialog,window.navigateToDriveBreadcrumbInOpen&&delete window.navigateToDriveBreadcrumbInOpen}};async function p(t,n){const i=document.getElementById("onedrive-open-item-list");if(i){i.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">Loading...</div>';try{let i;if("Google Drive"===t.name){const e="root"===n?"'root' in parents and trashed=false":`'${n}' in parents and trashed=false`;i="https://www.googleapis.com/drive/v3/files?"+new URLSearchParams({q:e,fields:"files(id,name,mimeType)",pageSize:100})}else{if("OneDrive"!==t.name)return void e.notificationManager.open({text:"Unkonwn Drive Provider:${provider}",type:"error",timeout:5e3});i="root"===n?"https://graph.microsoft.com/v1.0/me/drive/root/children":`https://graph.microsoft.com/v1.0/me/drive/items/${n}/children`}const a=await fetch(i,{headers:{Authorization:"Bearer "+t.token}});if(!a.ok)throw new Error("Failed to load items");const r=await a.json();!function(e,t){const n=document.getElementById("onedrive-open-item-list");if(!n)return;let i,a;"Google Drive"===t.name?(i=e.filter(e=>"application/vnd.google-apps.folder"===e.mimeType),a=e.filter(e=>"application/vnd.google-apps.folder"!==e.mimeType&&(e.name.endsWith(".txt")||e.name.endsWith(".html")||e.name.endsWith(".htm")||e.name.endsWith(".md")||e.name.endsWith(".json")||e.name.endsWith(".doc")||e.name.endsWith(".docx")))):(i=e.filter(e=>e.folder),a=e.filter(e=>e.file&&(e.name.endsWith(".txt")||e.name.endsWith(".html")||e.name.endsWith(".htm")||e.name.endsWith(".md")||e.name.endsWith(".json")||e.name.endsWith(".doc")||e.name.endsWith(".docx"))));if(0===i.length&&0===a.length)return void(n.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">No folders or supported files in this location</div>');let r='<div style="display: flex; flex-direction: column; gap: 5px;">';i.forEach(e=>{r+=`\n\t\t\t\t\t<div class="onedrive-item" data-id="${e.id}" data-name="${o(e.name)}" data-is-folder="true"\n\t\t\t\t\t\t style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"\n\t\t\t\t\t\t onmouseover="if(!this.classList.contains('selected')) this.style.background='#f0f0f0'" \n\t\t\t\t\t\t onmouseout="if(!this.classList.contains('selected')) this.style.background='white'"\n\t\t\t\t\t\t onclick="window.selectDriveFileToOpen(this,'${e.id}', '${o(e.name)}')"\t\t\t\t         \n\t\t\t\t\t\t ondblclick="window.openDriveFolderInOpenDialog('${e.id}', '${o(e.name)}')">\n\t\t\t\t\t\t<span style="font-size: 24px;">üìÅ</span>\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t    <div style="font-weight: 500; color: #333;">${o(e.name)}</div>\n\t\t\t\t\t\t    <div style="font-size: 11px; color: #666;">Folder</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t`}),a.forEach(e=>{var t;r+=`\n\t\t\t\t\t<div class="onedrive-item" data-id="${e.id}" data-name="${o(e.name)}" data-is-folder="false"\n\t\t\t\t\t\t style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"\n\t\t\t\t\t\t onmouseover="if(!this.classList.contains('selected')) this.style.background='#f0f0f0'" \n\t\t\t\t\t\t onmouseout="if(!this.classList.contains('selected')) this.style.background='white'"\n\t\t\t\t\t\t onclick="window.selectDriveFileToOpen(this,'${e.id}', '${o(e.name)}')">\n\t\t\t\t\t\t<span style="font-size: 24px;">üìÑ</span>\n\t\t\t\t\t\t<div>\n\t\t\t\t\t\t    <div style="font-weight: 500; color: #333;">${o(e.name)}</div>\n\t\t\t\t\t\t    <div style="font-size: 11px; color: #666;">${t=e.size,t<1024?t+" B":t<1048576?(t/1024).toFixed(1)+" KB":(t/1048576).toFixed(1)+" MB"}</div>\n\t\t\t\t\t\t</div>\n\t\t\t\t\t</div>\n\t\t\t\t`}),r+="</div>",n.innerHTML=r}(r.value||r.files||[],t)}catch(e){console.error("Error loading items:",e),i.innerHTML=`<div style="text-align: center; padding: 20px; color: #ea4335;">Failed to load items: ${e.message}</div>`}}}function m(){const e=document.getElementById("onedrive-open-breadcrumb");if(!e)return;let t="<span>‚òÅÔ∏è</span> ";d.forEach((e,n)=>{n>0&&(t+=" / "),t+=`<a href="#" onclick="window.navigateToDriveBreadcrumbInOpen(${n}); return false;" style="color: #0078d4; text-decoration: none;">${o(e.name)}</a>`}),e.innerHTML=t}s=e.windowManager.open(c),"save"===n?s.enable("save-button"):s.disable("save-button"),setTimeout(()=>{s&&p(t,i)},100),window.selectDriveFileToOpen=function(e,t,i){document.querySelectorAll(".onedrive-item").forEach(e=>{e.classList.remove("selected"),e.style.background="white"}),e.classList.add("selected"),e.style.background="#e3f2fd";"true"===e.dataset.isFolder?(a=e.dataset.id,"open"===n&&s.disable("save-button")):(r={id:t,name:i},s.enable("save-button"))},window.openDriveFolderInOpenDialog=function(e,n){i=e,d.push({id:e,name:n}),m(),p(t,e)},window.navigateToDriveBreadcrumbInOpen=function(e){d=d.slice(0,e+1),i=d[e].id,m(),p(t,i)}}function o(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}return e.ui.registry.addMenuItem("googledriveopen",{text:"Google Drive",onAction:function(){n("google","open")}}),e.ui.registry.addMenuItem("onedriveopen",{text:"OneDrive",onAction:function(){n("onedrive","open")}}),e.ui.registry.addMenuItem("googledrivesave",{text:"Google Drive",onAction:function(){n("google","save")}}),e.ui.registry.addMenuItem("onedrivesave",{text:"OneDrive",onAction:function(){n("onedrive","save")}}),{getMetadata:function(){return{name:"Open your Drive",url:"http://yoursite.com"}}}});