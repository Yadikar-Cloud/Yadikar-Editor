tinymce.PluginManager.add("savetoonedrive",function(e,n){async function t(){const n=await fetch("/api/onedrive/token"),t=await n.json();t.authenticated&&t.token?i(t.token):function(){const n={title:"Sign In Required",size:"normal",body:{type:"panel",items:[{type:"htmlpanel",html:'\n                            <div style="text-align: center; padding: 40px 20px;">\n                                <div style="font-size: 64px; margin-bottom: 20px;">‚òÅÔ∏è</div>\n                                <h3 style="margin-bottom: 10px; color: #333;">Sign in to OneDrive</h3>\n                                <p style="color: #666; margin-bottom: 30px;">\n                                    You need to sign in with your Microsoft account to save to OneDrive.\n                                </p>\n                            </div>\n                        '}]},buttons:[{type:"cancel",text:"Cancel"},{type:"custom",text:"Sign In with Microsoft",name:"signin",primary:!0}],onAction:function(e,n){"signin"===n.name&&(e.close(),function(){const e=600,n=700,t=(screen.width-e)/2,i=(screen.height-n)/2;window.open("/auth/onedrive","OneDriveAuth",`width=${e},height=${n},left=${t},top=${i},toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes`)}())}};e.windowManager.open(n)}()}function i(n){window.openOneDriveFolderInSaveDialog&&delete window.openOneDriveFolderInSaveDialog,window.navigateToOneDriveBreadcrumb&&delete window.navigateToOneDriveBreadcrumb;let t="root",i=[{id:"root",name:"My OneDrive"}],r="root",a=null;const d={title:"Save to OneDrive",size:"medium",body:{type:"panel",items:[{type:"htmlpanel",html:`\n                            <div id="onedrive-save-dialog-container" style="min-height: auto !important;">\n                                <div id="onedrive-breadcrumb" style="padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-size: 13px;">\n                                    <span>‚òÅÔ∏è My OneDrive</span>\n                                </div>\n                                <div id="onedrive-item-list" style="padding: 10px; max-height: 360px; overflow-y: auto; border-bottom: 1px solid #ddd;">\n                                    <div style="text-align: center; padding: 20px; color: #666;">\n                                        Loading...\n                                    </div>\n                                </div>\n                                <div style="padding: 15px; background: #f9f9f9;">\n                                    \x3c!-- File Name Row --\x3e\n                                    <div style="display: flex; align-items: center; margin-bottom: 10px;">\n                                        <label for="onedrive-filename" style="width: 90px; font-weight: bold;">\n                                            File Name:\n                                        </label>\n                                        <input type="text" id="onedrive-filename" value="Untitled" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">\n                                    </div>\n                                    \x3c!-- File Type Row --\x3e\n                                    <div style="display: flex; align-items: center;">\n                                        <label for="onedrive-extension" style="width: 90px; font-weight: bold;">\n                                            File type:\n                                        </label>\n                                        <select id="onedrive-extension" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">\n                                            ${window.getSelectOptions().map(e=>`<option value="${e.value}">${e.text}</option>`).join("")}\n                                        </select>\n                                    </div>\n                                </div>\n                            </div>\n                        `}]},buttons:[{type:"cancel",text:"Cancel"},{type:"submit",text:"Save",primary:!0}],onSubmit:function(t){!async function(n,t,i){const o=document.getElementById("onedrive-filename").value.trim(),r=document.getElementById("onedrive-extension").value;if(!o)return void e.notificationManager.open({text:"Please enter a file name",type:"error",timeout:3e3});const a=o+r,d=e.getContent();i.close(),e.notificationManager.open({text:"Converting and saving to OneDrive...",type:"info"});try{const i=await window.fileConverter.convert(d,r);let o;o=i instanceof Blob?i:new Blob([i],{type:window.getMimeType(r)});const s="root"===t?`https://graph.microsoft.com/v1.0/me/drive/root:/${a}:/content`:`https://graph.microsoft.com/v1.0/me/drive/items/${t}:/${a}:/content`,l=await fetch(s,{method:"PUT",headers:{Authorization:"Bearer "+n,"Content-Type":window.getMimeType(r)},body:o});if(!l.ok){const e=await l.json();throw new Error(e.error.message||"Unknown error")}{const n=await l.json();window.currentOneDriveFile={id:n.id,name:a},e.notificationManager.open({text:"‚úÖ Saved: "+a,type:"success",timeout:3e3})}}catch(n){console.error("Error saving file:",n),e.notificationManager.open({text:"Failed to save: "+n.message,type:"error",timeout:5e3})}}(n,r,t)},onClose:function(){window.openOneDriveFolderInSaveDialog&&delete window.openOneDriveFolderInSaveDialog,window.navigateToOneDriveBreadcrumb&&delete window.navigateToOneDriveBreadcrumb}};async function s(e,n){const t=document.getElementById("onedrive-item-list");if(t){t.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">Loading...</div>';try{const t="root"===n?"https://graph.microsoft.com/v1.0/me/drive/root/children":`https://graph.microsoft.com/v1.0/me/drive/items/${n}/children`,i=await fetch(t,{headers:{Authorization:"Bearer "+e}});if(!i.ok)throw new Error("Failed to load items");!function(e){const n=document.getElementById("onedrive-item-list");if(!n)return;if(0===e.length)return void(n.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">No items in this location<br><small>You can still save the file here</small></div>');let t='<div style="display: flex; flex-direction: column; gap: 5px;">';e.forEach(e=>{const n=void 0!==e.folder,i=n?"üìÅ":"üìÑ",r=n?`window.openOneDriveFolderInSaveDialog('${e.id}', '${o(e.name)}')`:"";t+=`\n                    <div class="onedrive-item" data-id="${e.id}" data-name="${o(e.name)}" data-is-folder="${n}"\n                         style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"\n                         onmouseover="this.style.background='#f0f0f0'" \n                         onmouseout="this.style.background='white'"\n                         onclick="selectOneDriveItem(this)"\n                         ondblclick="${r}">\n                        <span style="font-size: 24px;">${i}</span>\n                        <span>${o(e.name)}</span>\n                    </div>\n                `}),t+="</div>",n.innerHTML=t}((await i.json()).value||[])}catch(e){console.error("Error loading items:",e),t.innerHTML=`<div style="text-align: center; padding: 20px; color: #ea4335;">Failed to load items: ${e.message}</div>`}}}function l(){const e=document.getElementById("onedrive-breadcrumb");if(!e)return;let n="<span>‚òÅÔ∏è</span> ";i.forEach((e,t)=>{t>0&&(n+=" / "),n+=`<a href="#" onclick="window.navigateToOneDriveBreadcrumb(${t}); return false;" style="color: #0078d4; text-decoration: none;">${o(e.name)}</a>`}),e.innerHTML=n}a=e.windowManager.open(d),setTimeout(()=>{a&&s(n,t)},100),window.selectOneDriveItem=function(e){document.querySelectorAll(".onedrive-item").forEach(e=>{e.classList.remove("selected"),e.style.background="white"}),e.classList.add("selected"),e.style.background="#e3f2fd";"true"===e.dataset.isFolder&&(r=e.dataset.id)},window.openOneDriveFolderInSaveDialog=function(e,o){t=e,r=e,i.push({id:e,name:o}),l(),s(n,e)},window.navigateToOneDriveBreadcrumb=function(e){i=i.slice(0,e+1),t=i[e].id,r=t,l(),s(n,t)}}function o(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}return e.ui.registry.addButton("savetoonedrive",{text:"Save to OneDrive",onAction:function(){t()}}),e.ui.registry.addMenuItem("savetoonedrive",{text:"OneDrive",onAction:function(){t()}}),window.addEventListener("message",async function(n){if("onedrive-auth-success"===n.data.type){e.notificationManager.open({text:"Successfully signed in to OneDrive!",type:"success",timeout:3e3});const n=await fetch("/api/onedrive/token"),t=await n.json();t.authenticated&&i(t.token)}}),{getMetadata:function(){return{name:"Save to OneDrive",url:"http://yoursite.com"}}}});