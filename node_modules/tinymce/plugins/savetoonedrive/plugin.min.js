tinymce.PluginManager.add("savetoonedrive",function(e,n){async function t(){const n=await fetch("/api/onedrive/token"),t=await n.json();t.authenticated&&t.token?o(t.token):function(){const n={title:"Sign In Required",size:"normal",body:{type:"panel",items:[{type:"htmlpanel",html:'\n                            <div style="text-align: center; padding: 40px 20px;">\n                                <div style="font-size: 64px; margin-bottom: 20px;">☁️</div>\n                                <h3 style="margin-bottom: 10px; color: #333;">Sign in to OneDrive</h3>\n                                <p style="color: #666; margin-bottom: 30px;">\n                                    You need to sign in with your Microsoft account to save to OneDrive.\n                                </p>\n                            </div>\n                        '}]},buttons:[{type:"cancel",text:"Cancel"},{type:"custom",text:"Sign In with Microsoft",name:"signin",primary:!0}],onAction:function(e,n){"signin"===n.name&&(e.close(),function(){const e=600,n=700,t=(screen.width-e)/2,o=(screen.height-n)/2;window.open("/auth/onedrive","OneDriveAuth",`width=${e},height=${n},left=${t},top=${o},toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes`)}())}};e.windowManager.open(n)}()}function o(n){const t={title:"Save to OneDrive",size:"normal",body:{type:"panel",items:[{type:"htmlpanel",html:`\n                            <div style="padding: 20px;">\n                                <div style="margin-bottom: 15px;">\n                                    <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px;">\n                                        File Name:\n                                    </label>\n                                    <input \n                                        type="text" \n                                        id="onedrive-filename" \n                                        value="Untitled" \n                                        style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box;"\n                                    >\n                                </div>\n                                \n                                <div style="margin-bottom: 15px;">\n                                    <label style="display: block; margin-bottom: 6px; font-weight: 600; font-size: 13px;">\n                                        File type:\n                                    </label>\n                                    <select \n                                        id="onedrive-extension" \n                                        style="width: 100%; padding: 10px; border: 1px solid #ccc; border-radius: 4px; background: white; box-sizing: border-box;"\n                                    >\n                                        ${window.getSelectOptions().map(e=>`<option value="${e.value}">${e.text}</option>`).join("")}\n                                    </select>\n                                </div>\n                            </div>\n                        `}]},buttons:[{type:"cancel",text:"Cancel"},{type:"submit",text:"Save",primary:!0}],onSubmit:function(t){!async function(n,t){const o=document.getElementById("onedrive-filename").value.trim(),i=document.getElementById("onedrive-extension").value;if(!o)return void e.notificationManager.open({text:"Please enter a file name",type:"error",timeout:3e3});const a=o+i,r=e.getContent();t.close(),e.notificationManager.open({text:"Converting and saving to OneDrive...",type:"info"});try{const t=await window.fileConverter.convert(r,i);let o;o=t instanceof Blob?t:new Blob([t],{type:window.getMimeType(i)});const s=`https://graph.microsoft.com/v1.0/me/drive/root:/${a}:/content`,c=await fetch(s,{method:"PUT",headers:{Authorization:"Bearer "+n,"Content-Type":window.getMimeType(i)},body:o});if(!c.ok){const e=await c.json();throw new Error(e.error.message||"Unknown error")}{const n=await c.json();window.currentOneDriveFile={id:n.id,name:a},e.notificationManager.open({text:"✅ Saved: "+a,type:"success",timeout:3e3})}}catch(n){console.error("Error saving file:",n),e.notificationManager.open({text:"Failed to save: "+n.message,type:"error",timeout:5e3})}}(n,t)}};e.windowManager.open(t)}return e.ui.registry.addButton("savetoonedrive",{text:"Save to OneDrive",onAction:function(){t()}}),e.ui.registry.addMenuItem("savetoonedrive",{text:"OneDrive",onAction:function(){t()}}),window.addEventListener("message",async function(n){if("onedrive-auth-success"===n.data.type){e.notificationManager.open({text:"Successfully signed in to OneDrive!",type:"success",timeout:3e3});const n=await fetch("/api/onedrive/token"),t=await n.json();t.authenticated&&o(t.token)}}),{getMetadata:function(){return{name:"Save to OneDrive",url:"http://yoursite.com"}}}});