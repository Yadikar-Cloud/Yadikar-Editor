tinymce.PluginManager.add('screenshot', function(editor, url) {
    
    // Add button to toolbar
    editor.ui.registry.addButton('screenshot', {
        text: 'Screenshot',
        icon: 'image',
        tooltip: 'Take a screenshot of the editor content',
        onAction: function() {
            saveAsImage();
        }
    });

    // Add menu item
    editor.ui.registry.addMenuItem('screenshot', {
        text: 'Screenshot',
        icon: 'image',
        onAction: function() {
            saveAsImage();
        }
    });

    async function saveAsImage() {
        try {
            // Check if html2canvas is available
            if (typeof html2canvas === 'undefined') {
                editor.notificationManager.open({
                    text: 'html2canvas library not loaded. Please include it in your page.',
                    type: 'error',
                    timeout: 5000
                });
                return;
            }

            editor.notificationManager.open({
                text: 'Generating screenshot...',
                type: 'info'
            });

            // Add empty line offset for better screenshot
            const originalContent = editor.getContent();
            const content = originalContent + '<p>&nbsp;</p>';
            editor.setContent(content);

            // Get the editor body element
            const elem = editor.getBody();

            // Generate canvas from editor content
            const canvas = await html2canvas(elem, {
                backgroundColor: '#ffffff',
                scale: 2, // Higher quality
                logging: false,
                useCORS: true
            });

            // Restore original content
            editor.setContent(originalContent);

            // Convert canvas to blob and download
            canvas.toBlob(function(blob) {
                if (blob) {
                    // Use modern download method
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = 'editor-screenshot-' + Date.now() + '.png';
                    document.body.appendChild(a);
                    a.click();
                    document.body.removeChild(a);
                    URL.revokeObjectURL(url);

                    editor.notificationManager.open({
                        text: 'Screenshot saved!',
                        type: 'success',
                        timeout: 3000
                    });
                } else {
                    editor.notificationManager.open({
                        text: 'Failed to create screenshot',
                        type: 'error',
                        timeout: 3000
                    });
                }
            });

        } catch (error) {
            console.error('Screenshot error:', error);
            editor.notificationManager.open({
                text: 'Failed to create screenshot: ' + error.message,
                type: 'error',
                timeout: 5000
            });
        }
    }

    return {
        getMetadata: function() {
            return {
                name: 'Screenshot',
                url: 'http://yoursite.com'
            };
        }
    };
});
