tinymce.PluginManager.add("openfromdrive",function(e,t){async function n(e,t){let n=!1;const o=await window.requireCloudAuth(e,function(e){i(e,t),n=!0});o&&!n&&i(window.cloudProviders[e],t)}function i(n,i){window.selectDriveFileToOpen&&delete window.selectDriveFileToOpen,window.openDriveFolderInOpenDialog&&delete window.openDriveFolderInOpenDialog,window.navigateToDriveBreadcrumbInOpen&&delete window.navigateToDriveBreadcrumbInOpen;let r="root",d="root",a=null,l=[{id:"root",name:"My Drive"}],s=null;const c={title:"Open from Drive",size:"medium",body:{type:"panel",items:[{type:"htmlpanel",html:`\n\t\t\t\t\t\t    <div id="onedrive-open-dialog-container" style="min-height: 400px !important;">\n\t\t\t\t\t\t        <div id="onedrive-open-breadcrumb" style="padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-size: 13px;">\n\t\t\t\t\t\t            <span>‚òÅÔ∏è My ${n.name}</span>\n\t\t\t\t\t\t        </div>\n\t\t\t\t\t\t        <div id="onedrive-open-item-list" style="padding: 10px; max-height: 400px; overflow-y: auto;">\n\t\t\t\t\t\t            <div style="text-align: center; padding: 20px; color: #666;">\n\t\t\t\t\t\t                Loading...\n\t\t\t\t\t\t            </div>\n\t\t\t\t\t\t        </div>\n\t\t\t\t\t\t        ${"save"===i?'<div style="padding: 15px; background: #f9f9f9;"><div style="display: flex; align-items: center; margin-bottom: 10px;"><label for="onedrive-filename" style="width: 90px; font-weight: bold;">File Name:</label><input type="text" id="onedrive-filename" value="Untitled" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;"></div><div style="display: flex; align-items: center;"><label for="onedrive-extension" style="width: 90px; font-weight: bold;">File type:</label><select id="onedrive-extension" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">'+fileTypeOptions+"</select></div></div>":""}\n\t\t\t\t\t\t    </div>\n\t\t\t\t\t\t`}]},buttons:[{type:"cancel",text:"Cancel"},{type:"submit",text:"Save",enabled:!1,primary:!0,name:"save-button"}],onSubmit:function(o){"save"===i?async function(t,n,i){const o=document.getElementById("onedrive-filename").value.trim(),r=document.getElementById("onedrive-extension").value;if(!o)return void e.notificationManager.open({text:"Please enter a file name",type:"error",timeout:3e3});const d=o+r,a=e.getContent();i.close();try{const i=await window.fileConverter.convert(a,r);let o;o=i instanceof Blob?i:new Blob([i],{type:window.getMimeType(r)});const l="root"===n?`https://graph.microsoft.com/v1.0/me/drive/root:/${d}:/content`:`https://graph.microsoft.com/v1.0/me/drive/items/${n}:/${d}:/content`,s=await fetch(l,{method:"PUT",headers:{Authorization:"Bearer "+t,"Content-Type":window.getMimeType(r)},body:o});if(!s.ok){const e=await s.json();throw new Error(e.error.message||"Unknown error")}{const t=await s.json();window.currentOneDriveFile={id:t.id,name:d},e.notificationManager.open({text:"‚úÖ Saved: "+d,type:"success",timeout:3e3})}}catch(t){console.error("Error saving file:",t),e.notificationManager.open({text:"Failed to save: "+t.message,type:"error",timeout:5e3})}}(n.token,d,o):async function(n,i){try{if("Google Drive"===i.name){fileId}else if("OneDrive"===i.name){n.id}const o=await fetch(t,{headers:{Authorization:"Bearer "+i.token}});if(!o.ok)throw new Error("Failed to download file");const r=n.name.substring(n.name.lastIndexOf(".")).toLowerCase();if(".html"===r){const t=await o.text();e.setContent(t)}else{if(".docx"===r){const e=await o.blob();htmlContent=await window.fileConverter.convertToHtml(e,r)}else{const e=await o.text();htmlContent=await window.fileConverter.convertToHtml(e,r)}setTimeout(()=>{window.reapplyPageView&&window.reapplyPageView(htmlContent)},100)}window.currentDriveFile={id:n.id,name:n.name},e.notificationManager.open({text:"Opened: "+n.name,type:"success",timeout:3e3})}catch(t){console.error("Error loading file:",t),e.notificationManager.open({text:"Failed to open file: "+t.message,type:"error",timeout:5e3})}}(a,n)},onClose:function(){window.selectDriveFileToOpen&&delete window.selectDriveFileToOpen,window.openDriveFolderInOpenDialog&&delete window.openDriveFolderInOpenDialog,window.navigateToDriveBreadcrumbInOpen&&delete window.navigateToDriveBreadcrumbInOpen}};async function p(t,n){const i=document.getElementById("onedrive-open-item-list");if(i){i.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">Loading...</div>';try{let i;if("Google Drive"===t.name){const e="root"===n?"'root' in parents and trashed=false":`'${n}' in parents and trashed=false`;i="https://www.googleapis.com/drive/v3/files?"+new URLSearchParams({q:e,fields:"files(id,name,mimeType)",pageSize:100})}else{if("OneDrive"!==t.name)return void e.notificationManager.open({text:"Unkonwn Drive Provider:${provider}",type:"error",timeout:5e3});i="root"===n?"https://graph.microsoft.com/v1.0/me/drive/root/children":`https://graph.microsoft.com/v1.0/me/drive/items/${n}/children`}const r=await fetch(i,{headers:{Authorization:"Bearer "+t.token}});if(!r.ok)throw new Error("Failed to load items");const d=await r.json();!function(e,t){const n=document.getElementById("onedrive-open-item-list");if(!n)return;let i,r;"Google Drive"===t.name?(i=e.filter(e=>"application/vnd.google-apps.folder"===e.mimeType),r=e.filter(e=>"application/vnd.google-apps.folder"!==e.mimeType&&(e.name.endsWith(".txt")||e.name.endsWith(".html")||e.name.endsWith(".htm")||e.name.endsWith(".md")||e.name.endsWith(".json")||e.name.endsWith(".doc")||e.name.endsWith(".docx")))):(i=e.filter(e=>e.folder),r=e.filter(e=>e.file&&(e.name.endsWith(".txt")||e.name.endsWith(".html")||e.name.endsWith(".htm")||e.name.endsWith(".md")||e.name.endsWith(".json")||e.name.endsWith(".doc")||e.name.endsWith(".docx"))));if(0===i.length&&0===r.length)return void(n.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">No folders or supported files in this location</div>');let d='<div style="display: flex; flex-direction: column; gap: 5px;">';i.forEach(e=>{d+=`\n\t\t\t\t    <div class="onedrive-item" data-id="${e.id}" data-name="${o(e.name)}" data-is-folder="true"\n\t\t\t\t         style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"\n\t\t\t\t         onmouseover="this.style.background='#f0f0f0'" \n\t\t\t\t         onmouseout="this.style.background='white'"\n\t\t\t\t         onclick="window.selectDriveFileToOpen(this,'${file.id}', '${o(file.name)}')"\t\t\t\t         \n\t\t\t\t         ondblclick="window.openDriveFolderInOpenDialog('${e.id}', '${o(e.name)}')">\n\t\t\t\t        <span style="font-size: 24px;">üìÅ</span>\n\t\t\t\t        <div>\n\t\t\t\t            <div style="font-weight: 500; color: #333;">${o(e.name)}</div>\n\t\t\t\t            <div style="font-size: 11px; color: #666;">Folder</div>\n\t\t\t\t        </div>\n\t\t\t\t    </div>\n\t\t\t\t`}),r.forEach(e=>{var t;d+=`\n\t\t\t\t    <div class="onedrive-item" data-id="${e.id}" data-name="${o(e.name)}" data-is-folder="false"\n\t\t\t\t         style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"\n\t\t\t\t         onmouseover="this.style.background='#f0f0f0'" \n\t\t\t\t         onmouseout="this.style.background='white'"\n\t\t\t\t         onclick="window.selectDriveFileToOpen(this,'${e.id}', '${o(e.name)}')">\n\t\t\t\t        <span style="font-size: 24px;">üìÑ</span>\n\t\t\t\t        <div>\n\t\t\t\t            <div style="font-weight: 500; color: #333;">${o(e.name)}</div>\n\t\t\t\t            <div style="font-size: 11px; color: #666;">${t=e.size,t<1024?t+" B":t<1048576?(t/1024).toFixed(1)+" KB":(t/1048576).toFixed(1)+" MB"}</div>\n\t\t\t\t        </div>\n\t\t\t\t    </div>\n\t\t\t\t`}),d+="</div>",n.innerHTML=d}(d.value||d.files||[],t)}catch(e){console.error("Error loading items:",e),i.innerHTML=`<div style="text-align: center; padding: 20px; color: #ea4335;">Failed to load items: ${e.message}</div>`}}}function m(){const e=document.getElementById("onedrive-open-breadcrumb");if(!e)return;let t="<span>‚òÅÔ∏è</span> ";l.forEach((e,n)=>{n>0&&(t+=" / "),t+=`<a href="#" onclick="window.navigateToDriveBreadcrumbInOpen(${n}); return false;" style="color: #0078d4; text-decoration: none;">${o(e.name)}</a>`}),e.innerHTML=t}s=e.windowManager.open(c),"save"===i&&s.enable("save-button"),setTimeout(()=>{s&&p(n,r)},100),window.selectOneDriveItem=function(e,t,n){document.querySelectorAll(".onedrive-item").forEach(e=>{e.classList.remove("selected"),e.style.background="white"}),e.classList.add("selected"),e.style.background="#e3f2fd";"true"===e.dataset.isFolder?(d=e.dataset.id,"open"===i&&s.disable("save-button")):(a={id:t,name:n},s.enable("save-button"))},window.openDriveFolderInOpenDialog=function(e,t){r=e,l.push({id:e,name:t}),m(),p(n,e)},window.navigateToDriveBreadcrumbInOpen=function(e){l=l.slice(0,e+1),r=l[e].id,m(),p(n,r)}}function o(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}return e.ui.registry.addMenuItem("opengoogledrive",{text:"Google Drive",onAction:function(){n("google","open")}}),e.ui.registry.addMenuItem("openonedrive",{text:"OneDrive",onAction:function(){n("onedrive","open")}}),e.ui.registry.addMenuItem("opengoogledrive",{text:"Google Drive",onAction:function(){n("google","save")}}),e.ui.registry.addMenuItem("openonedrive",{text:"OneDrive",onAction:function(){n("onedrive","save")}}),{getMetadata:function(){return{name:"Open from Drive",url:"http://yoursite.com"}}}});