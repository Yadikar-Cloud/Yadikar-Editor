tinymce.PluginManager.add('pdfImport', function(editor, url) {
    
    let fileHandle = null;
	var pdfjsLib = window["pdfjs-dist/build/pdf"];
    // Add button to toolbar
    editor.ui.registry.addButton('pdfimport', {
        text: 'Import PDF',
        onAction: function() {
            pdf2text(editor);
        }
    });

    // Add menu item
    editor.ui.registry.addMenuItem('pdfimport', {
        text: 'Import PDF',
        onAction: function() {
            pdf2text(editor);
        }
    });

	async function openFile() {
		try {
		    if (!window.showOpenFilePicker) {
		        editor.notificationManager.open({
		            text: 'File System Access API is not supported in your browser. Please use Chrome, Edge, or Opera.',
		            type: 'error',
		            timeout: 5000
		        });
		        return;
		    }
		    
		    const options = {
		        types: [
		            {
		                description: 'PDF file',
		                accept: { 'application/pdf': ['.pdf'] }
		            },		        
		            {
		                description: 'PNG file',
		                accept: { 'image/png': ['.png'] }
		            },		        
		            {
		                description: 'JPEG file',
		                accept: { 'image/jpeg': ['.jpeg'] }
		            },
		            {
		                description: 'WebP file',
		                accept: { 'image/webp': ['.webp'] }
		            },
		            {
		                description: 'TIFF file',
		                accept: { 'image/tiff': ['.tiff'] }
		            }
		        ],
		        multiple: false,
		        excludeAcceptAllOption: true
		    };
		    
		    [fileHandle] = await window.showOpenFilePicker(options);
		    return await fileHandle.getFile();		    
		} catch (error) {
		    if (error.name !== 'AbortError') {
		        console.error('Error opening file:', error);
		        editor.notificationManager.open({
		            text: 'Failed to open file: ' + error.message,
		            type: 'error',
		            timeout: 5000
		        });
		    }
		}
	}
	
	async function runOCR(url, dialogInstance) {
		try {
		    // Create worker with logger included
		    const worker = await Tesseract.createWorker('eng', 1, {
		        logger: (m) => {
		            console.log(m);
		            if (m.status === 'recognizing text') {
		                const progress = Math.round(m.progress * 100);
		                dialogInstance.redial({
		                    title: 'Importing PDF...',
		                    body: {
		                        type: 'panel',
		                        items: [
		                            {
		                                type: 'htmlpanel',
		                                html: `
		                                    <label for="file-progress">File progress:</label>
		                                    <progress id="file-progress" max="100" value="${progress}">${progress}%</progress>
		                                `
		                            }
		                        ]
		                    },
		                    buttons: []
		                });
		            }
		        }
		    });
		    
		    // Recognize text
		    const result = await worker.recognize(url);
		    console.log("result", result);
		    
		    // Terminate worker
		    await worker.terminate();
		    
		    return result.data.text;
		    
		} catch (error) {
		    console.error('OCR Error:', error);
		    throw error;
		}
	}

	async function pdfToImage(pdfBinary, dialogInstance) {
	  try {
		// 1. Load the PDF document
		const loadingTask = pdfjsLib.getDocument({ data: pdfBinary });
		const pdf = await loadingTask.promise;
		console.log("PDF loaded");

		// 2. Fetch the first page
		const page = await pdf.getPage(1);
		console.log("Page loaded");

		const scale = 1.5;
		const viewport = page.getViewport({ scale: scale });

		// 3. Prepare canvas
		const canvas = document.createElement("canvas");
		const context = canvas.getContext("2d");
		canvas.height = viewport.height;
		canvas.width = viewport.width;

		// 4. Render PDF page into canvas
		const renderContext = {
		  canvasContext: context,
		  viewport: viewport
		};
		
		await page.render(renderContext).promise;
		console.log("Page rendered");

		// 5. Run OCR and return the final result
		return await runOCR(canvas, dialogInstance);

	  } catch (reason) {
		console.error("Error processing PDF:", reason);
		throw reason; // Re-throw so the caller knows it failed
	  }
	}

	function insertOCRContent(text) {
		editor.setContent(text);
		// Recalculate pages
		setTimeout(() => {
		    if (window.reapplyPageView) {
		        window.reapplyPageView(text);
		    }
		}, 100);		
	}
	
	async function pdf2text(editor)
	{
		var file = await openFile();
		var content = '';
		
		const dialogConfig = {
		    title: 'Importing PDF...',
		    size: 'small',
		    body: {
		        type: 'panel',
		        items: [
		            {
		                type: 'htmlpanel',
		                html: `
											<label for="file">File progress:</label>
											<progress id="file" max="100" value="70">70%</progress>	                
		                `
		            }
		        ]
		    },
		    buttons: []
		};
		var dialogInstance = editor.windowManager.open(dialogConfig);
		
		if (file.type.indexOf("image") !== -1) {
			content = await runOCR(file, dialogInstance);
			console.log("OCR Result:", content);
			insertOCRContent(content);
		}
		if (file.type.indexOf("pdf") !== -1) {
			var reader = new FileReader();

			reader.onload = async function () {
			  console.log(reader.result);
			  content = await pdfToImage(reader.result, dialogInstance);
			  console.log("OCR Result:", content);
			  insertOCRContent(content);
			};

			reader.readAsBinaryString(file);
		} 

		// close the progress dialog
		dialogInstance.close();
	}

  return {
      getMetadata: function() {
          return {
              name: 'Open from Computer',
              url: 'http://yoursite.com'
          };
      }
  };
});
