tinymce.PluginManager.add('pdfImport', function(editor, url) {
    
    let fileHandle = null;
	var pdfjsLib = window["pdfjs-dist/build/pdf"];
    // Add button to toolbar
    editor.ui.registry.addButton('pdfimport', {
        text: 'Import PDF',
        icon: 'export-pdf',
        onAction: function() {
            pdf2text(editor);
        }
    });

    // Add menu item
    editor.ui.registry.addMenuItem('pdfimport', {
        text: 'Import PDF',
        icon: 'export-pdf',
        onAction: function() {
            pdf2text(editor);
        }
    });

	async function openFile() {
		try {
		    if (!window.showOpenFilePicker) {
		        editor.notificationManager.open({
		            text: 'File System Access API is not supported in your browser. Please use Chrome, Edge, or Opera.',
		            type: 'error',
		            timeout: 5000
		        });
		        return;
		    }
		    
		    const options = {
		        types: [
		            {
		                description: 'PDF file',
		                accept: { 'application/pdf': ['.pdf'] }
		            },		        
		            {
		                description: 'PNG file',
		                accept: { 'image/png': ['.png'] }
		            },		        
		            {
		                description: 'JPEG file',
		                accept: { 'image/jpeg': ['.jpeg'] }
		            },
		            {
		                description: 'WebP file',
		                accept: { 'image/webp': ['.webp'] }
		            },
		            {
		                description: 'TIFF file',
		                accept: { 'image/tiff': ['.tiff'] }
		            }
		        ],
		        multiple: false,
		        excludeAcceptAllOption: true
		    };
		    
		    [fileHandle] = await window.showOpenFilePicker(options);
		    return await fileHandle.getFile();		    
		} catch (error) {
		    if (error.name !== 'AbortError') {
		        console.error('Error opening file:', error);
		        editor.notificationManager.open({
		            text: 'Failed to open file: ' + error.message,
		            type: 'error',
		            timeout: 5000
		        });
		    }
		}
	}
	
	async function runOCR(url, dialogInstance) {
		try {
		    // Create worker with logger included
		    const worker = await Tesseract.createWorker('eng', 1, {
		        logger: (m) => {
		            //console.log(m);
		            if (m.status === 'recognizing text') {
		                const progress = Math.round(m.progress * 100);
						if (dialogInstance) {
							dialogInstance.redial({
								title: 'Scanning PDF with Tesseract OCR...',
								body: {
									type: 'panel',
									items: [
										{
											type: 'htmlpanel',
											html: `
				                                    <div style="padding: 10px;">
				                                        <label for="ocr-progress">OCR Progress: ${progress}%</label>
				                                        <progress id="ocr-progress" max="100" value="${progress}" style="width: 100%; height: 20px;"></progress>
				                                    </div>
											`
										}
									]
								},
								buttons: []
							});
						}
		            }
		        }
		    });
		    
		    // Recognize text
		    const result = await worker.recognize(url);
		    //console.log("result", result);
		    
		    // Terminate worker
		    await worker.terminate();
		    
		    return result.data.text;
		    
		} catch (error) {
		    console.error('OCR Error:', error);
		    throw error;
		}
	}

	async function pdfToImage(pdfBinary) {
	  try {
        const dialogConfig = {
            title: 'Loading PDF...',
            body: {
                type: 'panel',
                items: [
                    {
                        type: 'htmlpanel',
                        html: `
                            <p>Loading PDF in progress</p>
                        `
                    }
                ]
            },
            buttons: []
        };
        var dialogInstance = editor.windowManager.open(dialogConfig);
		// 1. Load the PDF document
		const loadingTask = pdfjsLib.getDocument({ data: pdfBinary });
		const pdf = await loadingTask.promise;
		//console.log("PDF loaded");
		// 2. Fetch the first page
		const totalPages = pdf.numPages;
		var alltext = "";
		for(let i=1;i<totalPages+1;i++)
		{
			const page = await pdf.getPage(i);
			//console.log("Page loaded");
			
			const progressPercent = Math.round((i/totalPages)*100);
		    dialogInstance.redial({
		        title: 'Scanning PDF with Tesseract OCR...',
		        body: {
		            type: 'panel',
		            items: [
		                {
		                    type: 'htmlpanel',
		                    html: `
						            <div style="padding: 10px;">
						                <label for="file-progress">File progress: ${progressPercent}%</label>
						                <progress id="file-progress" max="100" value="${progressPercent}" style="width: 100%; height: 20px;"></progress>
						                <p>Processing page ${i} of ${totalPages}</p>
						            </div>
		                    `
		                }
		            ]
		        },
		        buttons: []
		    });
		    
			const scale = 1.5;
			const viewport = page.getViewport({ scale: scale });

			// 3. Prepare canvas
			const canvas = document.createElement("canvas");
			const context = canvas.getContext("2d");
			canvas.height = viewport.height;
			canvas.width = viewport.width;

			// 4. Render PDF page into canvas
			const renderContext = {
			  canvasContext: context,
			  viewport: viewport
			};
			
			await page.render(renderContext).promise;
			//console.log("Page rendered");

			// 5. Run OCR and return the final result
			alltext += await runOCR(canvas);
		}
		dialogInstance.close();
		return alltext;
	  } catch (reason) {
		console.error("Error processing PDF:", reason);
		throw reason; // Re-throw so the caller knows it failed
	  }
	}

	function insertOCRContent(text) {
		editor.setContent(text);
		// Recalculate pages
		setTimeout(() => {
		    if (window.reapplyPageView) {
		        window.reapplyPageView(text);
		    }
		}, 100);		
	}
	
	async function pdf2text(editor)
	{
		var file = await openFile();
		var content = '';
		
		const dialogConfig = {
		    title: 'Importing PDF...',
		    size: 'small',
		    body: {
		        type: 'panel',
		        items: [
		            {
		                type: 'htmlpanel',
		                html: `
											<label for="file">File progress:</label>
											<progress id="file" max="100" value="70">70%</progress>	                
		                `
		            }
		        ]
		    },
		    buttons: []
		};
		var dialogInstance = editor.windowManager.open(dialogConfig);
		
		if (file.type.indexOf("image") !== -1) {
			content = await runOCR(file, dialogInstance);
			//console.log("OCR Result:", content);
			editor.execCommand('pasteText', content);
		}
		if (file.type.indexOf("pdf") !== -1) {
			var reader = new FileReader();

			reader.onload = async function () {
			  //console.log(reader.result);
			  content = await pdfToImage(reader.result, dialogInstance);
			  //console.log("OCR Result:", content);
			  editor.execCommand('pasteText', content);	  
			};

			reader.readAsBinaryString(file);
		} 

		// close the progress dialog
		dialogInstance.close();
	}

  return {
      getMetadata: function() {
          return {
              name: 'Open from Computer',
              url: 'http://yoursite.com'
          };
      }
  };
});
