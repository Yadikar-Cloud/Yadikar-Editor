tinymce.PluginManager.add("pageview",function(e,t){let n=1;function o(t=null){n++;const o=e.dom.create("div",{class:"page","data-page":n});return t?e.dom.insertAfter(o,t):e.getBody().appendChild(o),o}function i(e){if(!e)return!1;let t=0;Array.from(e.children).forEach(e=>{t+=e.offsetHeight});return t>=200&&t>=876}function r(t){if(!t)return!1;const n=e.selection,o=n.getRng(),i=n.getNode(),r=Array.from(t.children);if(0===r.length)return!1;if(1===r.length){if((r[0].textContent||"").trim().length<10)return!1}const s=r[r.length-1];let c=!1;if((s===i||s.contains&&s.contains(i)||i.nodeType===Node.TEXT_NODE&&s.contains(i.parentNode))&&(c=!0),!c)return!1;if(!n.isCollapsed())return!1;const l=o.endContainer,d=o.endOffset;return l.nodeType===Node.TEXT_NODE?d===l.textContent.length:d===l.childNodes.length}function s(){const t=e.selection.getNode();return e.dom.getParent(t,".page")}function c(){const t=e.getBody().querySelectorAll(".page");t.forEach((e,n)=>{if(e.scrollHeight>1076){const i=Array.from(e.children);let r=-1;for(let t=0;t<i.length;t++){const n=i[t].getBoundingClientRect(),o=e.getBoundingClientRect();if(n.top-o.top>976){r=t;break}}if(r>0){let s=t[n+1];s||(s=o(e));i.slice(r).reverse().forEach(e=>{s.prepend(e)}),setTimeout(()=>c(),100)}}})}function l(){const t=e.selection,n=t.getNode();if(!e.dom.getParent(n,".page")){const n=e.getBody().querySelectorAll(".page"),o=n[n.length-1];if(o){if(!o.firstChild){const t=e.dom.create("p");t.innerHTML="<br>",o.appendChild(t)}const n=o.firstChild;t.select(n),t.collapse(!0)}}}e.ui.registry.addMenuItem("pageview",{text:"New document",icon:"new-document",onAction:function(){e.execCommand("mceNewDocument")}}),e.on("input keyup paste",function(e){setTimeout(()=>{l();const e=s();e&&(i(e)&&(e.style.borderBottom="3px solid #4285f4",setTimeout(()=>{e.style.borderBottom=""},1e3)),c())},50)}),e.on("keydown",function(t){if(13===t.keyCode){const n=s();if(n){var d=i(n),a=r(n);if(d&&a){t.preventDefault(),t.stopPropagation();const i=o(n);return setTimeout(()=>{if(!i.firstChild){const t=e.dom.create("p");t.innerHTML="&nbsp;",i.appendChild(t)}const t=i.firstChild;e.selection.select(t),e.selection.collapse(!0);const n=e.dom.createRng();n.setStart(t,0),n.setEnd(t,0),e.selection.setRng(n),e.focus(),i.scrollIntoView({behavior:"smooth",block:"start"})},100),!1}}setTimeout(()=>{l();s()&&c()},10)}if(8===t.keyCode||46===t.keyCode){const o=e.getBody().querySelectorAll(".page");if(1===o.length){const n=o[0],i=e.selection,r=e.dom.createRng();r.setStart(n,0),r.setEnd(i.getRng().startContainer,i.getRng().startOffset);const s=0===r.toString().trim().length,c=!i.isCollapsed()&&i.getNode()===n;if(s||c)return t.preventDefault(),t.stopPropagation(),c&&(n.innerHTML="<p><br></p>",e.selection.select(n.firstChild),e.selection.collapse(!0)),!1}setTimeout(()=>{!function(){const t=e.getBody().querySelectorAll(".page");t.forEach((e,t)=>{e.setAttribute("data-page",t+1)}),n=t.length}()},100)}}),e.on("keyup click",function(e){setTimeout(()=>{const e=s();e&&i(e)&&r(e)&&(e.style.borderBottom="2px solid #ff9800",setTimeout(()=>{e.style.borderBottom=""},500))},50)});e.addCommand("mceNewDocument",function(){const t=e.getBody();t.innerHTML="";const n=e.dom.create("div",{class:"page","data-page":1}),o=e.dom.create("p");o.innerHTML="<br>",n.appendChild(o),t.appendChild(n),l(),e.setDirty(!1)}),e.on("init",function(){const t=e.getBody();let n=t.querySelector(".page");if(!n){const o=t.innerHTML;if(t.innerHTML="",n=e.dom.create("div",{class:"page","data-page":1}),o.trim())n.innerHTML=o;else{const t=e.dom.create("p");t.innerHTML="<br>",n.appendChild(t)}t.appendChild(n)}l()}),e.addCommand("InsertPageBreak",function(){const t=s();if(t){const n=o(t);setTimeout(()=>{if(!n.firstChild){const t=e.dom.create("p");t.innerHTML="&nbsp;",n.appendChild(t)}const t=n.firstChild;e.selection.select(t),e.selection.collapse(!0);const o=e.dom.createRng();o.setStart(t,0),o.setEnd(t,0),e.selection.setRng(o),e.focus(),n.scrollIntoView({behavior:"smooth",block:"start"})},100)}}),window.reapplyPageView=function(t){if(!e||!e.getBody)return;const n=e.getBody();n.innerHTML="";const o=e.dom.create("div",{class:"page","data-page":1});if(t&&t.trim())o.innerHTML=t;else{const t=e.dom.create("p");t.innerHTML="<br>",o.appendChild(t)}n.appendChild(o),c()}});