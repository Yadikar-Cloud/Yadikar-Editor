tinymce.PluginManager.add("pageview",(function(e,t){let n=1;function o(t=null){n++;const o=e.dom.create("div",{class:"page","data-page":n});return t?e.dom.insertAfter(o,t):e.getBody().appendChild(o),o}function i(e){if(!e)return!1;let t=0;Array.from(e.children).forEach((e=>{t+=e.offsetHeight}));return t>=200&&t>=876}function s(t){if(!t)return!1;const n=e.selection,o=n.getRng(),i=n.getNode(),s=Array.from(t.children);if(0===s.length)return!1;if(1===s.length){if((s[0].textContent||"").trim().length<10)return!1}const r=s[s.length-1];let c=!1;if((r===i||r.contains&&r.contains(i)||i.nodeType===Node.TEXT_NODE&&r.contains(i.parentNode))&&(c=!0),!c)return!1;if(!n.isCollapsed())return!1;const l=o.endContainer,d=o.endOffset;return l.nodeType===Node.TEXT_NODE||l.nodeType===Node.ELEMENT_NODE?d===l.textContent.length:d===l.childNodes.length}function r(){const t=e.selection.getNode();return e.dom.getParent(t,".page")}function c(){const t=e.getBody().querySelectorAll(".page");t.forEach(((n,i)=>{if(n.scrollHeight>1076){const s=Array.from(n.children);let r=-1;for(let e=0;e<s.length;e++){const t=s[e].getBoundingClientRect(),o=n.getBoundingClientRect();if(t.bottom-o.top>1056){r=e;break}}if(r>0){let l=t[i+1];l||(l=o(n));s.slice(r).forEach((e=>{l.prepend(e)})),setTimeout((()=>{if(!l.firstChild){const t=e.dom.create("p");t.innerHTML="&nbsp;",l.appendChild(t)}const t=l.firstChild;e.selection.select(t),e.selection.collapse(!0);const n=e.dom.createRng();n.setStart(t,t.childNodes.length),n.setEnd(t,t.childNodes.length),e.selection.setRng(n),e.focus(),l.scrollIntoView({behavior:"smooth",block:"start"})}),100),setTimeout((()=>c()),100)}}}))}function l(){const t=e.selection,n=t.getNode();if(!e.dom.getParent(n,".page")){const n=e.getBody().querySelectorAll(".page"),o=n[n.length-1];if(o){if(!o.firstChild){const t=e.dom.create("p");t.innerHTML="<br>",o.appendChild(t)}const n=o.firstChild;t.select(n),t.collapse(!0)}}}e.ui.registry.addMenuItem("pageview",{text:"New document",icon:"new-document",onAction:function(){e.execCommand("mceNewDocument")}}),e.on("input keyup paste",(function(e){setTimeout((()=>{l();const e=r();e&&(i(e)&&(e.style.borderBottom="3px solid #4285f4",setTimeout((()=>{e.style.borderBottom=""}),1e3)),c())}),50)})),e.addCommand("pasteText",(function(t){t&&(e.insertContent(t),setTimeout((()=>{l();const e=r();e&&(i(e)&&(e.style.borderBottom="3px solid #4285f4",setTimeout((()=>{e.style.borderBottom=""}),1e3)),c())}),50))})),e.on("keydown",(function(t){if(13===t.keyCode){const n=r();if(n){var d=i(n),a=s(n);if(d&&a){t.preventDefault(),t.stopPropagation();const i=o(n);return setTimeout((()=>{if(!i.firstChild){const t=e.dom.create("p");t.innerHTML="&nbsp;",i.appendChild(t)}const t=i.firstChild;e.selection.select(t),e.selection.collapse(!0);const n=e.dom.createRng();n.setStart(t,0),n.setEnd(t,0),e.selection.setRng(n),e.focus(),i.scrollIntoView({behavior:"smooth",block:"start"})}),100),!1}}setTimeout((()=>{l();r()&&c()}),10)}if(8===t.keyCode||46===t.keyCode){const o=e.getBody().querySelectorAll(".page");if(1===o.length){const n=o[0],i=e.selection,s=i.getRng(),r=0===s.startOffset&&0===s.endOffset&&n.contains(s.startContainer),c=!i.isCollapsed()&&i.getNode()===n;if(r||c)return t.preventDefault(),t.stopPropagation(),c&&(n.innerHTML="<p><br></p>",e.selection.select(n.firstChild),e.selection.collapse(!0)),!1}setTimeout((()=>{!function(){const t=e.getBody().querySelectorAll(".page");t.forEach(((e,t)=>{e.setAttribute("data-page",t+1)})),n=t.length}()}),100)}}),!0,-1),e.on("keyup click",(function(e){setTimeout((()=>{const e=r();e&&i(e)&&s(e)&&(e.style.borderBottom="2px solid #ff9800",setTimeout((()=>{e.style.borderBottom=""}),500))}),50)}));e.addCommand("mceNewDocument",(function(){const t=e.getBody();t.innerHTML="";const n=e.dom.create("div",{class:"page","data-page":1}),o=e.dom.create("p");o.innerHTML="<br>",n.appendChild(o),t.appendChild(n),l(),e.setDirty(!1)})),e.on("init",(function(){const t=e.getBody();let n=t.querySelector(".page");if(!n){const o=t.innerHTML;if(t.innerHTML="",n=e.dom.create("div",{class:"page","data-page":1}),o.trim())n.innerHTML=o;else{const t=e.dom.create("p");t.innerHTML="<br>",n.appendChild(t)}t.appendChild(n)}l()})),e.addCommand("InsertPageBreak",(function(){const t=r();if(t){const n=o(t);setTimeout((()=>{if(!n.firstChild){const t=e.dom.create("p");t.innerHTML="&nbsp;",n.appendChild(t)}const t=n.firstChild;e.selection.select(t),e.selection.collapse(!0);const o=e.dom.createRng();o.setStart(t,0),o.setEnd(t,0),e.selection.setRng(o),e.focus(),n.scrollIntoView({behavior:"smooth",block:"start"})}),100)}})),window.reapplyPageView=function(t){if(!e||!e.getBody)return;const n=e.getBody();n.innerHTML="";const o=e.dom.create("div",{class:"page","data-page":1});if(t&&t.trim())o.innerHTML=t;else{const t=e.dom.create("p");t.innerHTML="<br>",o.appendChild(t)}n.appendChild(o),c()}}));