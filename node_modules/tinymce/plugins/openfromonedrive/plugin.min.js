tinymce.PluginManager.add("openfromonedrive",function(e,t){let n=!1;async function i(){if(n)return;let e=!1;await window.requireCloudAuth("onedrive",function(t){o(t.token),e=!0})&&!e&&o(window.cloudProviders.onedrive.token)}async function o(t){n=!0;try{const i=await fetch("https://graph.microsoft.com/v1.0/me/drive/root/children",{headers:{Authorization:"Bearer "+t}});if(!i.ok)throw new Error("Failed to load files from OneDrive");const o=await i.json();n=!1,function(t,n){const i=t.filter(e=>e.file&&(e.name.endsWith(".txt")||e.name.endsWith(".html")||e.name.endsWith(".htm")||e.name.endsWith(".md")||e.name.endsWith(".json")||e.name.endsWith(".doc")||e.name.endsWith(".docx")));if(0===i.length)return void e.notificationManager.open({text:"No supported text files found in OneDrive root folder",type:"warning",timeout:4e3});const o={title:"Select File from OneDrive",size:"medium",body:{type:"panel",items:[{type:"htmlpanel",html:`\n                        <div style="padding: 10px;">\n                            <div style="max-height: 400px; overflow-y: auto; padding: 5px;">\n                                ${i.map((e,t)=>{return`<div class="file-item" data-index="${t}" \n                 style="padding: 12px; border: 1px solid #ddd; margin-bottom: 8px; cursor: pointer; border-radius: 6px; display: flex; align-items: center; gap: 10px; transition: all 0.2s;" \n                 onmouseover="this.style.background='#f0f0f0'; this.style.borderColor='#0078d4';" \n                 onmouseout="this.style.background='white'; this.style.borderColor='#ddd';"\n                 onclick="window.selectOneDriveFile(${t})">\n                <span style="font-size: 24px;">ðŸ“„</span>\n                <div>\n                    <div style="font-weight: 500; color: #333;">${function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(e.name)}</div>\n                    <div style="font-size: 11px; color: #666;">${n=e.size,n<1024?n+" B":n<1048576?(n/1024).toFixed(1)+" KB":(n/1048576).toFixed(1)+" MB"}</div>\n                </div>\n            </div>`;var n}).join("")}\n                            </div>\n                        </div>\n                    `}]},buttons:[{type:"cancel",text:"Cancel"}]},r=e.windowManager.open(o);window.selectOneDriveFile=function(t){r.close();const o=i[t];o&&async function(t,n){e.notificationManager.open({text:"Loading file...",type:"info"});try{const i=await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${t.id}/content`,{headers:{Authorization:"Bearer "+n}});if(!i.ok)throw new Error("Failed to download file");const o=await i.text();e.setContent(o),window.currentOneDriveFile={id:t.id,name:t.name},e.notificationManager.open({text:"Opened: "+t.name,type:"success",timeout:3e3})}catch(t){console.error("Error loading file:",t),e.notificationManager.open({text:"Failed to open file: "+t.message,type:"error",timeout:5e3})}}(o,n)}}(o.value,t)}catch(t){n=!1,console.error("Error loading files:",t),e.notificationManager.open({text:"Failed to load OneDrive files: "+t.message,type:"error",timeout:5e3})}}return e.ui.registry.addButton("openfromonedrive",{text:"Open from OneDrive",onAction:function(){i()}}),e.ui.registry.addMenuItem("openfromonedrive",{text:"OneDrive",onAction:function(){i()}}),window.addEventListener("message",async function(t){if("onedrive-auth-success"===t.data.type){e.notificationManager.open({text:"Successfully signed in to OneDrive!",type:"success",timeout:3e3});const t=await fetch("/api/onedrive/token"),n=await t.json();n.authenticated&&o(n.token)}}),{getMetadata:function(){return{name:"Open from OneDrive",url:"http://yoursite.com"}}}});