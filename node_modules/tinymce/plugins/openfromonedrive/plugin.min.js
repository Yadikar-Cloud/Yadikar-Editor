tinymce.PluginManager.add("openfromonedrive",function(e,t){let n=!1;async function o(){if(n)return;const t=await fetch("/api/onedrive/token"),o=await t.json();o.authenticated&&o.token?i(o.token):function(){const t={title:"Sign In Required",size:"normal",body:{type:"panel",items:[{type:"htmlpanel",html:'\n                            <div style="text-align: center; padding: 40px 20px;">\n                                <div style="font-size: 64px; margin-bottom: 20px;">‚òÅÔ∏è</div>\n                                <h3 style="margin-bottom: 10px; color: #333;">Sign in to OneDrive</h3>\n                                <p style="color: #666; margin-bottom: 30px;">\n                                    You need to sign in with your Microsoft account to access your OneDrive files.\n                                </p>\n                            </div>\n                        '}]},buttons:[{type:"cancel",text:"Cancel"},{type:"custom",text:"Sign In with Microsoft",name:"signin",primary:!0}],onAction:function(t,n){"signin"===n.name&&(t.close(),function(){const t=600,n=700,o=(screen.width-t)/2,i=(screen.height-n)/2;window.open("/auth/onedrive","OneDriveAuth",`width=${t},height=${n},left=${o},top=${i},toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes`)||e.notificationManager.open({text:"Popup blocked! Please allow popups for this site.",type:"error",timeout:5e3})}())}};e.windowManager.open(t)}()}async function i(t){n=!0;try{const o=await fetch("https://graph.microsoft.com/v1.0/me/drive/root/children",{headers:{Authorization:"Bearer "+t}});if(!o.ok)throw new Error("Failed to load files from OneDrive");const i=await o.json();n=!1,function(t,n){const o=t.filter(e=>e.file&&(e.name.endsWith(".txt")||e.name.endsWith(".html")||e.name.endsWith(".htm")||e.name.endsWith(".md")||e.name.endsWith(".json")||e.name.endsWith(".doc")||e.name.endsWith(".docx")));if(0===o.length)return void e.notificationManager.open({text:"No supported text files found in OneDrive root folder",type:"warning",timeout:4e3});const i={title:"Select File from OneDrive",size:"medium",body:{type:"panel",items:[{type:"htmlpanel",html:`\n                        <div style="padding: 10px;">\n                            <div style="max-height: 400px; overflow-y: auto; padding: 5px;">\n                                ${o.map((e,t)=>{return`<div class="file-item" data-index="${t}" \n                 style="padding: 12px; border: 1px solid #ddd; margin-bottom: 8px; cursor: pointer; border-radius: 6px; display: flex; align-items: center; gap: 10px; transition: all 0.2s;" \n                 onmouseover="this.style.background='#f0f0f0'; this.style.borderColor='#0078d4';" \n                 onmouseout="this.style.background='white'; this.style.borderColor='#ddd';"\n                 onclick="window.selectOneDriveFile(${t})">\n                <span style="font-size: 24px;">üìÑ</span>\n                <div>\n                    <div style="font-weight: 500; color: #333;">${function(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}(e.name)}</div>\n                    <div style="font-size: 11px; color: #666;">${n=e.size,n<1024?n+" B":n<1048576?(n/1024).toFixed(1)+" KB":(n/1048576).toFixed(1)+" MB"}</div>\n                </div>\n            </div>`;var n}).join("")}\n                            </div>\n                        </div>\n                    `}]},buttons:[{type:"cancel",text:"Cancel"}]},r=e.windowManager.open(i);window.selectOneDriveFile=function(t){r.close();const i=o[t];i&&async function(t,n){e.notificationManager.open({text:"Loading file...",type:"info"});try{const o=await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${t.id}/content`,{headers:{Authorization:"Bearer "+n}});if(!o.ok)throw new Error("Failed to download file");const i=await o.text();e.setContent(i),window.currentOneDriveFile={id:t.id,name:t.name},e.notificationManager.open({text:"Opened: "+t.name,type:"success",timeout:3e3})}catch(t){console.error("Error loading file:",t),e.notificationManager.open({text:"Failed to open file: "+t.message,type:"error",timeout:5e3})}}(i,n)}}(i.value,t)}catch(t){n=!1,console.error("Error loading files:",t),e.notificationManager.open({text:"Failed to load OneDrive files: "+t.message,type:"error",timeout:5e3})}}return e.ui.registry.addButton("openfromonedrive",{text:"Open from OneDrive",onAction:function(){o()}}),e.ui.registry.addMenuItem("openfromonedrive",{text:"OneDrive",onAction:function(){o()}}),window.addEventListener("message",async function(t){if("onedrive-auth-success"===t.data.type){e.notificationManager.open({text:"Successfully signed in to OneDrive!",type:"success",timeout:3e3});const t=await fetch("/api/onedrive/token"),n=await t.json();n.authenticated&&i(n.token)}}),{getMetadata:function(){return{name:"Open from OneDrive",url:"http://yoursite.com"}}}});