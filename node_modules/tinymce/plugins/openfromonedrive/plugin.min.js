tinymce.PluginManager.add("openfromonedrive",function(e,n){let t=!1,i=!1;async function o(){let e=!1;i=!0;await window.requireCloudAuth("onedrive",function(n){d(n.token),e=!0,i=!1})&&!e&&(d(window.cloudProviders.onedrive.token),i=!1)}function d(n){window.selectOneDriveFileToOpen&&delete window.selectOneDriveFileToOpen,window.openOneDriveFolderInOpenDialog&&delete window.openOneDriveFolderInOpenDialog,window.navigateToOneDriveBreadcrumbInOpen&&delete window.navigateToOneDriveBreadcrumbInOpen;let i="root",o=[{id:"root",name:"My OneDrive"}],d=null;const a={title:"Open from OneDrive",size:"medium",body:{type:"panel",items:[{type:"htmlpanel",html:'\n\t\t                    <div id="onedrive-open-dialog-container" style="min-height: auto !important;">\n\t\t                        <div id="onedrive-open-breadcrumb" style="padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-size: 13px;">\n\t\t                            <span>‚òÅÔ∏è My OneDrive</span>\n\t\t                        </div>\n\t\t                        <div id="onedrive-open-item-list" style="padding: 10px; max-height: 400px; overflow-y: auto;">\n\t\t                            <div style="text-align: center; padding: 20px; color: #666;">\n\t\t                                Loading...\n\t\t                            </div>\n\t\t                        </div>\n\t\t                    </div>\n\t\t                '}]},buttons:[{type:"cancel",text:"Cancel"}],onClose:function(){t=!1,window.selectOneDriveFileToOpen&&delete window.selectOneDriveFileToOpen,window.openOneDriveFolderInOpenDialog&&delete window.openOneDriveFolderInOpenDialog,window.navigateToOneDriveBreadcrumbInOpen&&delete window.navigateToOneDriveBreadcrumbInOpen}};async function l(e,n){const t=document.getElementById("onedrive-open-item-list");if(t){t.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">Loading...</div>';try{const t="root"===n?"https://graph.microsoft.com/v1.0/me/drive/root/children":`https://graph.microsoft.com/v1.0/me/drive/items/${n}/children`,i=await fetch(t,{headers:{Authorization:"Bearer "+e}});if(!i.ok)throw new Error("Failed to load items");!function(e){const n=document.getElementById("onedrive-open-item-list");if(!n)return;const t=e.filter(e=>e.folder),i=e.filter(e=>e.file&&(e.name.endsWith(".txt")||e.name.endsWith(".html")||e.name.endsWith(".htm")||e.name.endsWith(".md")||e.name.endsWith(".json")||e.name.endsWith(".doc")||e.name.endsWith(".docx")));if(0===t.length&&0===i.length)return void(n.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">No folders or supported files in this location</div>');let o='<div style="display: flex; flex-direction: column; gap: 5px;">';t.forEach(e=>{o+=`\n\t\t            <div class="onedrive-item" data-id="${e.id}" data-name="${r(e.name)}" data-is-folder="true"\n\t\t                 style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"\n\t\t                 onmouseover="this.style.background='#f0f0f0'" \n\t\t                 onmouseout="this.style.background='white'"\n\t\t                 ondblclick="window.openOneDriveFolderInOpenDialog('${e.id}', '${r(e.name)}')">\n\t\t                <span style="font-size: 24px;">üìÅ</span>\n\t\t                <div>\n\t\t                    <div style="font-weight: 500; color: #333;">${r(e.name)}</div>\n\t\t                    <div style="font-size: 11px; color: #666;">Folder</div>\n\t\t                </div>\n\t\t            </div>\n\t\t        `}),i.forEach(e=>{var n;o+=`\n\t\t            <div class="onedrive-item" data-id="${e.id}" data-name="${r(e.name)}" data-is-folder="false"\n\t\t                 style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"\n\t\t                 onmouseover="this.style.background='#f0f0f0'" \n\t\t                 onmouseout="this.style.background='white'"\n\t\t                 onclick="window.selectOneDriveFileToOpen('${e.id}', '${r(e.name)}')">\n\t\t                <span style="font-size: 24px;">üìÑ</span>\n\t\t                <div>\n\t\t                    <div style="font-weight: 500; color: #333;">${r(e.name)}</div>\n\t\t                    <div style="font-size: 11px; color: #666;">${n=e.size,n<1024?n+" B":n<1048576?(n/1024).toFixed(1)+" KB":(n/1048576).toFixed(1)+" MB"}</div>\n\t\t                </div>\n\t\t            </div>\n\t\t        `}),o+="</div>",n.innerHTML=o}((await i.json()).value||[])}catch(e){console.error("Error loading items:",e),t.innerHTML=`<div style="text-align: center; padding: 20px; color: #ea4335;">Failed to load items: ${e.message}</div>`}}}function s(){const e=document.getElementById("onedrive-open-breadcrumb");if(!e)return;let n="<span>‚òÅÔ∏è</span> ";o.forEach((e,t)=>{t>0&&(n+=" / "),n+=`<a href="#" onclick="window.navigateToOneDriveBreadcrumbInOpen(${t}); return false;" style="color: #0078d4; text-decoration: none;">${r(e.name)}</a>`}),e.innerHTML=n}d=e.windowManager.open(a),setTimeout(()=>{d&&l(n,i)},100),window.selectOneDriveFileToOpen=function(t,i){d.close();!async function(n,t){try{const i=await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${n.id}/content`,{headers:{Authorization:"Bearer "+t}});if(!i.ok)throw new Error("Failed to download file");const o=n.name.substring(n.name.lastIndexOf(".")).toLowerCase();if(".html"===o){const n=await i.text();e.setContent(n)}else{if(".docx"===o){const e=await i.blob();htmlContent=await window.fileConverter.convertToHtml(e,o)}else{const e=await i.text();htmlContent=await window.fileConverter.convertToHtml(e,o)}setTimeout(()=>{window.reapplyPageView&&window.reapplyPageView(htmlContent)},100)}window.currentOneDriveFile={id:n.id,name:n.name},e.notificationManager.open({text:"Opened: "+n.name,type:"success",timeout:3e3})}catch(n){console.error("Error loading file:",n),e.notificationManager.open({text:"Failed to open file: "+n.message,type:"error",timeout:5e3})}}({id:t,name:i},n)},window.openOneDriveFolderInOpenDialog=function(e,t){i=e,o.push({id:e,name:t}),s(),l(n,e)},window.navigateToOneDriveBreadcrumbInOpen=function(e){o=o.slice(0,e+1),i=o[e].id,s(),l(n,i)}}function r(e){const n=document.createElement("div");return n.textContent=e,n.innerHTML}return e.ui.registry.addButton("openfromonedrive",{text:"Open from OneDrive",onAction:function(){o()}}),e.ui.registry.addMenuItem("openfromonedrive",{text:"OneDrive",onAction:function(){o()}}),window.addEventListener("message",async function(n){if("onedrive-auth-success"===n.data.type&&i){i=!1,e.notificationManager.open({text:"Successfully signed in to OneDrive!",type:"success",timeout:3e3});const n=await fetch("/api/onedrive/token"),t=await n.json();t.authenticated&&window.cloudProviders.onedrive&&(window.cloudProviders.onedrive.token=t.token,d(window.cloudProviders.onedrive.token))}}),{getMetadata:function(){return{name:"Open from OneDrive",url:"http://yoursite.com"}}}});