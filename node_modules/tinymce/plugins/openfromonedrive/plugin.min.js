tinymce.PluginManager.add("openfromonedrive",function(e,n){let t=!1;async function o(){if(t)return;const n=await fetch("/api/onedrive/token"),o=await n.json();o.authenticated&&o.token?i(o.token):function(){const n={title:"Sign In Required",size:"normal",body:{type:"panel",items:[{type:"htmlpanel",html:'\n                            <div style="text-align: center; padding: 40px 20px;">\n                                <div style="font-size: 64px; margin-bottom: 20px;">☁️</div>\n                                <h3 style="margin-bottom: 10px; color: #333;">Sign in to OneDrive</h3>\n                                <p style="color: #666; margin-bottom: 30px;">\n                                    You need to sign in with your Microsoft account to access your OneDrive files.\n                                </p>\n                            </div>\n                        '}]},buttons:[{type:"cancel",text:"Cancel"},{type:"custom",text:"Sign In with Microsoft",name:"signin",primary:!0}],onAction:function(n,t){"signin"===t.name&&(n.close(),function(){const n=600,t=700,o=(screen.width-n)/2,i=(screen.height-t)/2;window.open("/auth/onedrive","OneDriveAuth",`width=${n},height=${t},left=${o},top=${i},toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes`)||e.notificationManager.open({text:"Popup blocked! Please allow popups for this site.",type:"error",timeout:5e3})}())}};e.windowManager.open(n)}()}function i(n){t=!0;const o={clientId:"YOUR_CLIENT_ID",action:"query",multiSelect:!1,advanced:{queryParameters:"select=id,name,size,file,folder,@microsoft.graph.downloadUrl",filter:".txt,.html,.md,.pdf,.docx"},success:function(n){t=!1,n&&n.value&&n.value.length>0&&async function(n){e.notificationManager.open({text:"Loading file...",type:"info"});try{const t=n["@microsoft.graph.downloadUrl"];if(!t)throw new Error("No download URL available");const o=await fetch(t),i=await o.text();e.setContent(i),window.currentOneDriveFile={id:n.id,name:n.name},e.notificationManager.open({text:"Opened: "+n.name,type:"success",timeout:3e3})}catch(n){console.error("Error loading file:",n),e.notificationManager.open({text:"Failed to open file: "+n.message,type:"error",timeout:5e3})}}(n.value[0])},cancel:function(){t=!1,e.notificationManager.open({text:"Selection cancelled",type:"info",timeout:2e3})},error:function(n){t=!1,console.error("OneDrive picker error:",n),e.notificationManager.open({text:"Failed to open OneDrive picker",type:"error",timeout:3e3})}};OneDrive.open(o)}return e.ui.registry.addButton("openfromonedrive",{text:"Open from OneDrive",onAction:function(){o()}}),e.ui.registry.addMenuItem("openfromonedrive",{text:"OneDrive",onAction:function(){o()}}),window.addEventListener("message",async function(n){if("onedrive-auth-success"===n.data.type){e.notificationManager.open({text:"Successfully signed in to OneDrive!",type:"success",timeout:3e3});const n=await fetch("/api/onedrive/token"),t=await n.json();t.authenticated&&i(t.token)}}),{getMetadata:function(){return{name:"Open from OneDrive",url:"http://yoursite.com"}}}});