tinymce.PluginManager.add('openfromonedrive', function(editor, url) {
    let pickerOpen = false;
    
    editor.ui.registry.addButton('openfromonedrive', {
        text: 'Open from OneDrive',
        onAction: function() {
            openOneDrivePicker();
        }
    });

    editor.ui.registry.addMenuItem('openfromonedrive', {
        text: 'OneDrive',
        onAction: function() {
            openOneDrivePicker();
        }
    });

    async function openOneDrivePicker() {
        if (pickerOpen) {
            return;
        }

        // Check if authenticated
        const response = await fetch('/api/onedrive/token');
        const data = await response.json();

        if (!data.authenticated || !data.token) {
            showSignInDialog();
            return;
        }

        // Open OneDrive picker
        openOneDriveFilePicker(data.token);
    }

    function showSignInDialog() {
        const dialogConfig = {
            title: 'Sign In Required',
            size: 'normal',
            body: {
                type: 'panel',
                items: [
                    {
                        type: 'htmlpanel',
                        html: `
                            <div style="text-align: center; padding: 40px 20px;">
                                <div style="font-size: 64px; margin-bottom: 20px;">☁️</div>
                                <h3 style="margin-bottom: 10px; color: #333;">Sign in to OneDrive</h3>
                                <p style="color: #666; margin-bottom: 30px;">
                                    You need to sign in with your Microsoft account to access your OneDrive files.
                                </p>
                            </div>
                        `
                    }
                ]
            },
            buttons: [
                {
                    type: 'cancel',
                    text: 'Cancel'
                },
                {
                    type: 'custom',
                    text: 'Sign In with Microsoft',
                    name: 'signin',
                    primary: true
                }
            ],
            onAction: function(api, details) {
                if (details.name === 'signin') {
                    api.close();
                    openSignInPopup();
                }
            }
        };

        editor.windowManager.open(dialogConfig);
    }

    function openSignInPopup() {
        const width = 600;
        const height = 700;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        
        const popup = window.open(
            '/auth/onedrive',
            'OneDriveAuth',
            `width=${width},height=${height},left=${left},top=${top},toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes`
        );
        
        if (!popup) {
            editor.notificationManager.open({
                text: 'Popup blocked! Please allow popups for this site.',
                type: 'error',
                timeout: 5000
            });
        }
    }

    function openOneDriveFilePicker(token) {
        pickerOpen = true;

        const options = {
            clientId: "YOUR_CLIENT_ID", // Replace with actual client ID
            action: "query",
            multiSelect: false,
            advanced: {
                queryParameters: "select=id,name,size,file,folder,@microsoft.graph.downloadUrl",
                filter: ".txt,.html,.md,.pdf,.docx"
            },
            success: function(files) {
                pickerOpen = false;
                if (files && files.value && files.value.length > 0) {
                    loadFileContent(files.value[0], token);
                }
            },
            cancel: function() {
                pickerOpen = false;
                editor.notificationManager.open({
                    text: 'Selection cancelled',
                    type: 'info',
                    timeout: 2000
                });
            },
            error: function(error) {
                pickerOpen = false;
                console.error('OneDrive picker error:', error);
                editor.notificationManager.open({
                    text: 'Failed to open OneDrive picker',
                    type: 'error',
                    timeout: 3000
                });
            }
        };

        OneDrive.open(options);
    }

    async function loadFileContent(file, token) {
        editor.notificationManager.open({
            text: 'Loading file...',
            type: 'info'
        });

        try {
            const downloadUrl = file['@microsoft.graph.downloadUrl'];
            
            if (!downloadUrl) {
                throw new Error('No download URL available');
            }

            const response = await fetch(downloadUrl);
            const content = await response.text();

            editor.setContent(content);
            
            window.currentOneDriveFile = {
                id: file.id,
                name: file.name
            };

            editor.notificationManager.open({
                text: 'Opened: ' + file.name,
                type: 'success',
                timeout: 3000
            });

        } catch (error) {
            console.error('Error loading file:', error);
            editor.notificationManager.open({
                text: 'Failed to open file: ' + error.message,
                type: 'error',
                timeout: 5000
            });
        }
    }

    // Listen for auth success
    window.addEventListener('message', async function(event) {
        if (event.data.type === 'onedrive-auth-success') {
            editor.notificationManager.open({
                text: 'Successfully signed in to OneDrive!',
                type: 'success',
                timeout: 3000
            });
            
            // Retry opening picker
            const response = await fetch('/api/onedrive/token');
            const data = await response.json();
            if (data.authenticated) {
                openOneDriveFilePicker(data.token);
            }
        }
    });

    return {
        getMetadata: function() {
            return {
                name: 'Open from OneDrive',
                url: 'http://yoursite.com'
            };
        }
    };
});
