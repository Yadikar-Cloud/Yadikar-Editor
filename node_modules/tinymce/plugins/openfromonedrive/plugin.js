tinymce.PluginManager.add('openfromonedrive', function(editor, url) {
    let pickerOpen = false;
    
    editor.ui.registry.addButton('openfromonedrive', {
        text: 'Open from OneDrive',
        onAction: function() {
            openOneDrivePicker();
        }
    });

    editor.ui.registry.addMenuItem('openfromonedrive', {
        text: 'OneDrive',
        onAction: function() {
            openOneDrivePicker();
        }
    });

	async function openOneDrivePicker() {
		if (pickerOpen) {
		    return;
		}
		
		let pickerLoaded = false;
		
		// Use the global authentication system
		const authenticated = await window.requireCloudAuth('onedrive', function(provider) {
		    // This callback runs after successful authentication
		    loadOneDriveFiles(provider.token);
		    pickerLoaded = true;
		});
		
		// If already authenticated and callback didn't load the picker, load it now
		if (authenticated && !pickerLoaded) {
		    loadOneDriveFiles(window.cloudProviders.onedrive.token);
		}
	}

    function openSignInPopup() {
        const width = 600;
        const height = 700;
        const left = (screen.width - width) / 2;
        const top = (screen.height - height) / 2;
        
        const popup = window.open(
            '/auth/onedrive',
            'OneDriveAuth',
            `width=${width},height=${height},left=${left},top=${top},toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes`
        );
        
        if (!popup) {
            editor.notificationManager.open({
                text: 'Popup blocked! Please allow popups for this site.',
                type: 'error',
                timeout: 5000
            });
        }
    }

    async function loadOneDriveFiles(token) {
        pickerOpen = true;

        try {
            const response = await fetch('https://graph.microsoft.com/v1.0/me/drive/root/children', {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) {
                throw new Error('Failed to load files from OneDrive');
            }

            const data = await response.json();
            pickerOpen = false;
            
            showFileSelectionDialog(data.value, token);

        } catch (error) {
            pickerOpen = false;
            console.error('Error loading files:', error);
            editor.notificationManager.open({
                text: 'Failed to load OneDrive files: ' + error.message,
                type: 'error',
                timeout: 5000
            });
        }
    }

    function showFileSelectionDialog(files, token) {
        // Filter text-based files
		const textFiles = files.filter(f => 
			f.file && (
				f.name.endsWith('.txt') || 
				f.name.endsWith('.html') || 
				f.name.endsWith('.htm') ||
				f.name.endsWith('.md') ||
				f.name.endsWith('.json') ||
				f.name.endsWith('.doc') ||
				f.name.endsWith('.docx')
			)
		);

        if (textFiles.length === 0) {
            editor.notificationManager.open({
                text: 'No supported text files found in OneDrive root folder',
                type: 'warning',
                timeout: 4000
            });
            return;
        }

        const fileListHtml = textFiles.map((f, index) => 
            `<div class="file-item" data-index="${index}" 
                 style="padding: 12px; border: 1px solid #ddd; margin-bottom: 8px; cursor: pointer; border-radius: 6px; display: flex; align-items: center; gap: 10px; transition: all 0.2s;" 
                 onmouseover="this.style.background='#f0f0f0'; this.style.borderColor='#0078d4';" 
                 onmouseout="this.style.background='white'; this.style.borderColor='#ddd';"
                 onclick="window.selectOneDriveFile(${index})">
                <span style="font-size: 24px;">ðŸ“„</span>
                <div>
                    <div style="font-weight: 500; color: #333;">${escapeHtml(f.name)}</div>
                    <div style="font-size: 11px; color: #666;">${formatFileSize(f.size)}</div>
                </div>
            </div>`
        ).join('');

        const dialogConfig = {
            title: 'Select File from OneDrive',
            size: 'medium',
            body: {
                type: 'panel',
                items: [{
                    type: 'htmlpanel',
                    html: `
                        <div style="padding: 10px;">
                            <div style="max-height: 400px; overflow-y: auto; padding: 5px;">
                                ${fileListHtml}
                            </div>
                        </div>
                    `
                }]
            },
            buttons: [{
                type: 'cancel',
                text: 'Cancel'
            }]
        };

        const dialog = editor.windowManager.open(dialogConfig);

        window.selectOneDriveFile = function(index) {
            dialog.close();
            const file = textFiles[index];
            if (file) {
                loadFileContent(file, token);
            }
        };
    }

    async function loadFileContent(file, token) {
        editor.notificationManager.open({
            text: 'Loading file...',
            type: 'info'
        });

        try {
            // Get download URL
            const response = await fetch(`https://graph.microsoft.com/v1.0/me/drive/items/${file.id}/content`, {
                headers: {
                    'Authorization': 'Bearer ' + token
                }
            });

            if (!response.ok) {
                throw new Error('Failed to download file');
            }

            const content = await response.text();

            editor.setContent(content);
            
            window.currentOneDriveFile = {
                id: file.id,
                name: file.name
            };

            editor.notificationManager.open({
                text: 'Opened: ' + file.name,
                type: 'success',
                timeout: 3000
            });

        } catch (error) {
            console.error('Error loading file:', error);
            editor.notificationManager.open({
                text: 'Failed to open file: ' + error.message,
                type: 'error',
                timeout: 5000
            });
        }
    }

    function escapeHtml(text) {
        const div = document.createElement('div');
        div.textContent = text;
        return div.innerHTML;
    }

    function formatFileSize(bytes) {
        if (bytes < 1024) return bytes + ' B';
        if (bytes < 1024 * 1024) return (bytes / 1024).toFixed(1) + ' KB';
        return (bytes / (1024 * 1024)).toFixed(1) + ' MB';
    }

    // Listen for auth success
    window.addEventListener('message', async function(event) {
        if (event.data.type === 'onedrive-auth-success') {
            editor.notificationManager.open({
                text: 'Successfully signed in to OneDrive!',
                type: 'success',
                timeout: 3000
            });
            
            // Retry opening picker
            const response = await fetch('/api/onedrive/token');
            const data = await response.json();
            if (data.authenticated) {
                loadOneDriveFiles(data.token);
            }
        }
    });

    return {
        getMetadata: function() {
            return {
                name: 'Open from OneDrive',
                url: 'http://yoursite.com'
            };
        }
    };
});
