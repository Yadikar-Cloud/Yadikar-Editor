tinymce.PluginManager.add('settings', function(editor, url) {
    
    const STORAGE_KEY = 'tinymce_settings';
    let availableLanguages = [];
    
    // Default settings
    const defaults = {
        language: 'en_US',
        skin: 'oxide',
        fontSize: '14px',
        contentFontSize: '16px',
        contentFontType: 'Georgia',
        autosave: true,
        autosaveInterval: 30,
        spellcheck: true
    };

    // Load languages from JSON
    async function loadLanguages() {
        try {
            const response = await fetch(url + '/languages.json');
            availableLanguages = await response.json();
        } catch (error) {
            console.error('Failed to load languages:', error);
            availableLanguages = [
                { code: 'en_US', name: 'English (US)' },
                { code: 'it', name: 'Italian' },
                { code: 'es', name: 'Spanish' },
                { code: 'fr_FR', name: 'French' },
                { code: 'de', name: 'German' }
            ];
        }
    }

    // Get saved settings from localStorage
    function getSettings() {
        try {
            const saved = localStorage.getItem(STORAGE_KEY);
            return saved ? { ...defaults, ...JSON.parse(saved) } : defaults;
        } catch (error) {
            console.error('Error loading settings:', error);
            return defaults;
        }
    }

    // Save settings to localStorage
    function saveSettings(settings) {
        try {
            localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
            return true;
        } catch (error) {
            console.error('Error saving settings:', error);
            return false;
        }
    }

    // Apply settings and reinitialize editor
    function applySettings(newSettings) {
        // Save settings
        if (!saveSettings(newSettings)) {
            editor.notificationManager.open({
                text: 'Failed to save settings',
                type: 'error',
                timeout: 3000
            });
            return;
        }

        // Show notification
        editor.notificationManager.open({
            text: 'Settings saved! Reloading editor...',
            type: 'info',
            timeout: 2000
        });

        // Reinitialize editor after a short delay
        setTimeout(() => {
            // Store current content
            const content = editor.getContent();
            
            // Get editor selector
            const selector = editor.settings.selector;
            
            // Remove current instance
            tinymce.remove();
            
            // Reinitialize with new settings
            window.initializeTinyMCE(newSettings, content);
        }, 500);
    }

    // Show settings dialog
    function showSettingsDialog() {
        const currentSettings = getSettings();

        // Build language options for dropdown
        const languageOptions = availableLanguages.map(lang => ({
            text: lang.name,
            value: lang.code
        }));

        // Build skin options
        const skinOptions = [
            { text: 'Light (Oxide)', value: 'oxide' },
            { text: 'Dark (Oxide Dark)', value: 'oxide-dark' }
        ];

        // Build font size options
        const fontSizeOptions = [
            { text: 'Small (12px)', value: '12px' },
            { text: 'Medium (14px)', value: '14px' },
            { text: 'Large (16px)', value: '16px' },
            { text: 'Extra Large (18px)', value: '18px' }
        ];

        // Build skin options
        const fontTypeOptions = [
            { text: 'Arial', value: 'arial' },
            { text: 'Courier New', value: 'courier new' },
            { text: 'Georgia', value: 'georgia' },
            { text: 'UKIJ Ekran', value: 'UKIJEkranRegular' },
            { text: 'UKIJ Chiwer Kesme', value: 'UKIJChiwerKesmeRegular' },
            { text: 'UKIJ Kufi', value: 'UKIJKufiRegular' }
        ];
        
        const dialogConfig = {
            title: 'Editor Settings',
            size: 'normal',
            body: {
                type: 'tabpanel',
                tabs: [
                    {
                        name: 'general',
                        title: 'General',
                        items: [
                            {
                                type: 'selectbox',
                                name: 'language',
                                label: 'Language',
                                items: languageOptions
                            },
                            {
                                type: 'selectbox',
                                name: 'skin',
                                label: 'Theme',
                                items: skinOptions
                            },
                            {
                                type: 'selectbox',
                                name: 'fontSize',
                                label: 'UI Font Size',
                                items: fontSizeOptions
                            },
                            {
                                type: 'selectbox',
                                name: 'contentFontSize',
                                label: 'Default Font Size',
                                items: fontSizeOptions
                            },
                            {
                                type: 'selectbox',
                                name: 'contentFontType',
                                label: 'Default Font Type',
                                items: fontTypeOptions
                            }
                        ]
                    },
                    {
                        name: 'editor',
                        title: 'Editor',
                        items: [
                            {
                                type: 'checkbox',
                                name: 'spellcheck',
                                label: 'Enable spell checker'
                            },
                            {
                                type: 'checkbox',
                                name: 'autosave',
                                label: 'Enable auto-save'
                            },
                            {
                                type: 'input',
                                name: 'autosaveInterval',
                                label: 'Auto-save interval (seconds)',
                                inputMode: 'numeric'
                            },
                            {
                                type: 'htmlpanel',
                                html: '<p style="color: #666; font-size: 12px; margin-top: 10px;"><strong>Note:</strong> Some changes require editor reload to take effect.</p>'
                            }
                        ]
                    }
                ]
            },
            buttons: [
                {
                    type: 'cancel',
                    text: 'Cancel'
                },
                {
                    type: 'submit',
                    text: 'Apply',
                    primary: true
                }
            ],
            initialData: currentSettings,
            onSubmit: function(api) {
                const data = api.getData();
                
                // Validate autosave interval
                if (data.autosave && (!data.autosaveInterval || data.autosaveInterval < 10)) {
                    editor.notificationManager.open({
                        text: 'Auto-save interval must be at least 10 seconds',
                        type: 'warning',
                        timeout: 3000
                    });
                    return;
                }

                api.close();
                applySettings(data);
            }
        };

        editor.windowManager.open(dialogConfig);
    }

    // Add toolbar button
    editor.ui.registry.addButton('settings', {
        text: 'Settings',
        icon: 'settings',
        tooltip: 'Editor Settings',
        onAction: function() {
            showSettingsDialog();
        }
    });

    // Add menu item
    editor.ui.registry.addMenuItem('settings', {
        text: 'Settings',
        icon: 'settings',
        onAction: function() {
            showSettingsDialog();
        }
    });

    // Load languages on init
    editor.on('init', function() {
        loadLanguages();
    });

    // Export settings getter for external use
    window.getTinyMCESettings = getSettings;

    return {
        getMetadata: function() {
            return {
                name: 'Settings',
                url: 'http://yoursite.com'
            };
        }
    };
});
