tinymce.PluginManager.add("openfromdrive",function(e,t){async function n(e){let t=!1;const n=await window.requireCloudAuth(e,function(e){i(e),t=!0});n&&!t&&i(window.cloudProviders[e])}function i(t){window.selectDriveFileToOpen&&delete window.selectDriveFileToOpen,window.openDriveFolderInOpenDialog&&delete window.openDriveFolderInOpenDialog,window.navigateToDriveBreadcrumbInOpen&&delete window.navigateToDriveBreadcrumbInOpen;let n="root",i=[{id:"root",name:"My Drive"}],r=null;const a={title:"Open from Drive",size:"medium",body:{type:"panel",items:[{type:"htmlpanel",html:'\n\t\t                    <div id="onedrive-open-dialog-container" style="min-height: 400px !important;">\n\t\t                        <div id="onedrive-open-breadcrumb" style="padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-size: 13px;">\n\t\t                            <span>‚òÅÔ∏è My Drive</span>\n\t\t                        </div>\n\t\t                        <div id="onedrive-open-item-list" style="padding: 10px; max-height: 400px; overflow-y: auto;">\n\t\t                            <div style="text-align: center; padding: 20px; color: #666;">\n\t\t                                Loading...\n\t\t                            </div>\n\t\t                        </div>\n\t\t                    </div>\n\t\t                '}]},buttons:[{type:"cancel",text:"Cancel"}],onClose:function(){window.selectDriveFileToOpen&&delete window.selectDriveFileToOpen,window.openDriveFolderInOpenDialog&&delete window.openDriveFolderInOpenDialog,window.navigateToDriveBreadcrumbInOpen&&delete window.navigateToDriveBreadcrumbInOpen}};async function l(t,n){const i=document.getElementById("onedrive-open-item-list");if(i){i.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">Loading...</div>';try{let i;if("Google Drive"===t.name){const e="root"===n?"'root' in parents and trashed=false":`'${n}' in parents and trashed=false`;i="https://www.googleapis.com/drive/v3/files?"+new URLSearchParams({q:e,fields:"files(id,name,mimeType)",pageSize:100})}else{if("OneDrive"!==t.name)return void e.notificationManager.open({text:"Unkonwn Drive Provider:${provider}",type:"error",timeout:5e3});i="root"===n?"https://graph.microsoft.com/v1.0/me/drive/root/children":`https://graph.microsoft.com/v1.0/me/drive/items/${n}/children`}const o=await fetch(i,{headers:{Authorization:"Bearer "+t.token}});if(!o.ok)throw new Error("Failed to load items");const r=await o.json();!function(e,t){const n=document.getElementById("onedrive-open-item-list");if(!n)return;let i,o;"Google Drive"===t.name?(i=e.filter(e=>"application/vnd.google-apps.folder"===e.mimeType),o=e.filter(e=>"application/vnd.google-apps.folder"!==e.mimeType&&(e.name.endsWith(".txt")||e.name.endsWith(".html")||e.name.endsWith(".htm")||e.name.endsWith(".md")||e.name.endsWith(".json")||e.name.endsWith(".doc")||e.name.endsWith(".docx")))):(i=e.filter(e=>e.folder),o=e.filter(e=>e.file&&(e.name.endsWith(".txt")||e.name.endsWith(".html")||e.name.endsWith(".htm")||e.name.endsWith(".md")||e.name.endsWith(".json")||e.name.endsWith(".doc")||e.name.endsWith(".docx"))));if(0===i.length&&0===o.length)return void(n.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">No folders or supported files in this location</div>');let r='<div style="display: flex; flex-direction: column; gap: 5px;">';i.forEach(e=>{r+=`\n\t\t\t\t    <div class="onedrive-item" data-id="${e.id}" data-name="${d(e.name)}" data-is-folder="true"\n\t\t\t\t         style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"\n\t\t\t\t         onmouseover="this.style.background='#f0f0f0'" \n\t\t\t\t         onmouseout="this.style.background='white'"\n\t\t\t\t         ondblclick="window.openDriveFolderInOpenDialog('${e.id}', '${d(e.name)}')">\n\t\t\t\t        <span style="font-size: 24px;">üìÅ</span>\n\t\t\t\t        <div>\n\t\t\t\t            <div style="font-weight: 500; color: #333;">${d(e.name)}</div>\n\t\t\t\t            <div style="font-size: 11px; color: #666;">Folder</div>\n\t\t\t\t        </div>\n\t\t\t\t    </div>\n\t\t\t\t`}),o.forEach(e=>{var t;r+=`\n\t\t\t\t    <div class="onedrive-item" data-id="${e.id}" data-name="${d(e.name)}" data-is-folder="false"\n\t\t\t\t         style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"\n\t\t\t\t         onmouseover="this.style.background='#f0f0f0'" \n\t\t\t\t         onmouseout="this.style.background='white'"\n\t\t\t\t         onclick="window.selectDriveFileToOpen('${e.id}', '${d(e.name)}')">\n\t\t\t\t        <span style="font-size: 24px;">üìÑ</span>\n\t\t\t\t        <div>\n\t\t\t\t            <div style="font-weight: 500; color: #333;">${d(e.name)}</div>\n\t\t\t\t            <div style="font-size: 11px; color: #666;">${t=e.size,t<1024?t+" B":t<1048576?(t/1024).toFixed(1)+" KB":(t/1048576).toFixed(1)+" MB"}</div>\n\t\t\t\t        </div>\n\t\t\t\t    </div>\n\t\t\t\t`}),r+="</div>",n.innerHTML=r}(r.value||r.files||[],t)}catch(e){console.error("Error loading items:",e),i.innerHTML=`<div style="text-align: center; padding: 20px; color: #ea4335;">Failed to load items: ${e.message}</div>`}}}function s(){const e=document.getElementById("onedrive-open-breadcrumb");if(!e)return;let t="<span>‚òÅÔ∏è</span> ";i.forEach((e,n)=>{n>0&&(t+=" / "),t+=`<a href="#" onclick="window.navigateToDriveBreadcrumbInOpen(${n}); return false;" style="color: #0078d4; text-decoration: none;">${d(e.name)}</a>`}),e.innerHTML=t}r=e.windowManager.open(a),setTimeout(()=>{r&&l(t,n)},100),window.selectDriveFileToOpen=function(e,n){r.close();o({id:e,name:n},t)},window.openDriveFolderInOpenDialog=function(e,o){n=e,i.push({id:e,name:o}),s(),l(t,e)},window.navigateToDriveBreadcrumbInOpen=function(e){i=i.slice(0,e+1),n=i[e].id,s(),l(t,n)}}async function o(n,i){try{if("Google Drive"===i.name){fileId}else if("OneDrive"===i.name){n.id}const o=await fetch(t,{headers:{Authorization:"Bearer "+i.token}});if(!o.ok)throw new Error("Failed to download file");const d=n.name.substring(n.name.lastIndexOf(".")).toLowerCase();if(".html"===d){const t=await o.text();e.setContent(t)}else{if(".docx"===d){const e=await o.blob();htmlContent=await window.fileConverter.convertToHtml(e,d)}else{const e=await o.text();htmlContent=await window.fileConverter.convertToHtml(e,d)}setTimeout(()=>{window.reapplyPageView&&window.reapplyPageView(htmlContent)},100)}window.currentDriveFile={id:n.id,name:n.name},e.notificationManager.open({text:"Opened: "+n.name,type:"success",timeout:3e3})}catch(t){console.error("Error loading file:",t),e.notificationManager.open({text:"Failed to open file: "+t.message,type:"error",timeout:5e3})}}function d(e){const t=document.createElement("div");return t.textContent=e,t.innerHTML}return e.ui.registry.addMenuItem("opengoogledrive",{text:"Google Drive",onAction:function(){n("google")}}),e.ui.registry.addMenuItem("openonedrive",{text:"OneDrive",onAction:function(){n("onedrive")}}),{getMetadata:function(){return{name:"Open from Drive",url:"http://yoursite.com"}}}});