tinymce.PluginManager.add('openfromcomputer', function(editor, url) {
    
    let fileHandle = null;

    // Add button to toolbar
    editor.ui.registry.addButton('openfromcomputer', {
        text: 'Open File',
        onAction: function() {
            openFile();
        }
    });

    // Add menu item
    editor.ui.registry.addMenuItem('openfromcomputer', {
        text: 'Local Device',
        onAction: function() {
            openFile();
        }
    });

	function getWellKnownDirectory(filePath) {
		// Normalize path to lowercase for comparison
		const normalizedPath = filePath.toLowerCase();
		
		// Check for well-known directories in order of specificity
		if (normalizedPath.includes('/downloads')) {
		    return 'downloads';
		}
		if (normalizedPath.includes('/desktop')) {
		    return 'desktop';
		}
		if (normalizedPath.includes('/documents')) {
		    return 'documents';
		}
		
		// Default fallback
		return 'documents';
	}	
	async function openFile(filePath) {
		try {
		    if (!window.showOpenFilePicker) {
		        editor.notificationManager.open({
		            text: 'File System Access API is not supported in your browser. Please use Chrome, Edge, or Opera.',
		            type: 'error',
		            timeout: 5000
		        });
		        return;
		    }
		    
		    const options = {
		        types: [
		            {
		                description: 'HTML file',
		                accept: { 'text/html': ['.html', '.htm'] }
		            },		        
		            {
		                description: 'Text file',
		                accept: { 'text/plain': ['.txt'] }
		            },
		            {
		                description: 'Markdown file',
		                accept: { 'text/markdown': ['.md'] }
		            },
		            {
		                description: 'Word Document',
		                accept: { 'application/vnd.openxmlformats-officedocument.wordprocessingml.document': ['.docx'] }
		            }
		        ],
		        startIn: getWellKnownDirectory(filePath),
		        multiple: false,
		        excludeAcceptAllOption: true
		    };
		    
		    [fileHandle] = await window.showOpenFilePicker(options);
		    const file = await fileHandle.getFile();
		    const extension = file.name.substring(file.name.lastIndexOf('.')).toLowerCase();
		    
		    let htmlContent;
		    
		    // Convert to HTML based on file type
		    if (extension === '.html') {
		    	const content = await file.text();
		    	editor.setContent(content);
		    } else {
				if (extension === '.docx') {
				    // For binary files, pass the blob
				    htmlContent = await window.fileConverter.convertToHtml(file, extension);
				} else {
				    // For text files, read as text first
				    const content = await file.text();
				    htmlContent = await window.fileConverter.convertToHtml(content, extension);
				}
				
				// Recalculate pages
				setTimeout(() => {
				    if (window.reapplyPageView) {
				        window.reapplyPageView(htmlContent);
				    }
				}, 100);		    
		    }
		    
		    window.currentLocalFile = {
		        handle: fileHandle,
		        name: file.name,
		        originalExtension: extension
		    };
   
		} catch (error) {
		    if (error.name !== 'AbortError') {
		        console.error('Error opening file:', error);
		        editor.notificationManager.open({
		            text: 'Failed to open file: ' + error.message,
		            type: 'error',
		            timeout: 5000
		        });
		    }
		}
	}
	async function askFileAccessPermission(editor, filePath)
	{
        const dialogConfig = {
            title: 'File Access Permission',
            body: {
                type: 'panel',
                items: [
                    {
						type: 'htmlpanel',
						html: '<p>Would you like to allow Yadikar Editor to access the file?</p>'
                    }
                ]
            },
		    buttons: [
		        {
		            type: 'cancel',
		            text: 'No'
		        },
		        {
		            type: 'submit',
		            text: 'Yes',
		            primary: true
		        }
		    ],
		    onSubmit: async function(api) {
		    	await openFile(filePath);
		    	api.close();
		    }
        };
        var dialogInstance = editor.windowManager.open(dialogConfig);		
	}
	editor.addCommand('cmdOpenFile', function(ui, filePath) {
		askFileAccessPermission(editor, filePath);
	});
	
    return {
        getMetadata: function() {
            return {
                name: 'Open from Computer',
                url: 'http://yoursite.com'
            };
        }
    };
});
