tinymce.PluginManager.add('openfromcomputer', function(editor, url) {
    
    let fileHandle = null;

    // Add button to toolbar
    editor.ui.registry.addButton('openfromcomputer', {
        text: 'Open File',
        onAction: function() {
            openFile();
        }
    });

    // Add menu item
    editor.ui.registry.addMenuItem('openfromcomputer', {
        text: 'from Local Device',
        onAction: function() {
            openFile();
        }
    });

    async function openFile() {
        try {
            // Check if File System Access API is supported
            if (!window.showOpenFilePicker) {
                editor.notificationManager.open({
                    text: 'File System Access API is not supported in your browser. Please use Chrome, Edge, or Opera.',
                    type: 'error',
                    timeout: 5000
                });
                return;
            }

            const options = {
                types: [
                    {
                        description: 'Text file',
                        accept: {
                            'text/plain': ['.txt']
                        }
                    },
                    {
                        description: 'HTML file',
                        accept: {
                            'text/html': ['.html', '.htm']
                        }
                    },
                    {
                        description: 'Markdown file',
                        accept: {
                            'text/markdown': ['.md']
                        }
                    }
                ],
                multiple: false,
                excludeAcceptAllOption: true
            };

            [fileHandle] = await window.showOpenFilePicker(options);
            const file = await fileHandle.getFile();
            const content = await file.text();
            
            editor.setContent(content);
            
            // Store file info
            window.currentLocalFile = {
                handle: fileHandle,
                name: file.name
            };

            editor.notificationManager.open({
                text: 'Opened: ' + file.name,
                type: 'success',
                timeout: 3000
            });

        } catch (error) {
            if (error.name !== 'AbortError') {
                console.error('Error opening file:', error);
                editor.notificationManager.open({
                    text: 'Failed to open file: ' + error.message,
                    type: 'error',
                    timeout: 5000
                });
            }
        }
    }

    return {
        getMetadata: function() {
            return {
                name: 'Open from Computer',
                url: 'http://yoursite.com'
            };
        }
    };
});
