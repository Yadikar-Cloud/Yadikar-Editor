tinymce.PluginManager.add("cloudsignin",function(o,e){async function t(o){try{const e=await fetch(window.cloudProviders[o].tokenUrl),t=await e.json();return window.cloudProviders[o].authenticated=t.authenticated||!1,window.cloudProviders[o].token=t.token||null,window.cloudProviders[o].apiKey=t.api_key||null,t.authenticated}catch(o){return console.error("Error checking authentication:",o),!1}}function n(e,t){const n=window.cloudProviders[e],i={title:"Sign In Required",body:{type:"panel",items:[{type:"htmlpanel",html:`\n                            <div style="text-align: center; padding: 20px;">\n                                <div style="font-size: 48px; margin-bottom: 20px;">\n                                    ${n.icon}\n                                </div>\n                            </div>\n                        `}]},buttons:[{type:"cancel",text:"Cancel"},{type:"custom",text:"Sign In with "+n.name,name:"signin",primary:!0}],onAction:function(n,i){"signin"===i.name&&(n.close(),function(e,t){const n=window.cloudProviders[e];window.pendingAuthCallback=t;const i=(screen.width-600)/2,a=(screen.height-700)/2;window.open(n.authUrl,"CloudAuth",`width=600,height=700,left=${i},top=${a},toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes`)||o.notificationManager.open({text:"Popup blocked! Please allow popups for this site.",type:"error",timeout:5e3})}(e,t))}};o.windowManager.open(i)}return window.cloudProviders={google:{name:"Google Drive",icon:'<img src="https://www.gstatic.com/images/branding/product/2x/drive_2020q4_64dp.png" alt="Google Drive" style="width: 128px; height: 128px;">',authUrl:"/auth/google",tokenUrl:"/api/google/token",logoutUrl:"/auth/google/logout",authenticated:!1,token:null},dropbox:{name:"Dropbox",icon:"ðŸ“¦",authUrl:"/auth/dropbox",tokenUrl:"/api/dropbox/token",logoutUrl:"/auth/dropbox/logout",authenticated:!1,token:null},onedrive:{name:"OneDrive",icon:'<img src="https://static2.sharepointonline.com/files/fabric/assets/brand-icons/product/svg/onedrive_48x1.svg" alt="OneDrive" style="width: 128px; height: 128px;">',authUrl:"/auth/onedrive",tokenUrl:"/api/onedrive/token",logoutUrl:"/auth/onedrive/logout",authenticated:!1,token:null}},window.addEventListener("message",async function(e){"google-auth-success"===e.data.type?(o.notificationManager.open({text:"Successfully signed in to Google Drive!",type:"success",timeout:3e3}),await t("google"),window.pendingAuthCallback&&(window.pendingAuthCallback(window.cloudProviders.google),window.pendingAuthCallback=null)):"google-auth-error"===e.data.type&&o.notificationManager.open({text:"Authentication failed: "+e.data.error,type:"error",timeout:5e3})}),window.requireCloudAuth=async function(o,e){return await t(o)?(e&&e(window.cloudProviders[o]),!0):(n(o,e),!1)},o.ui.registry.addButton("googlesignin",{text:"Google Drive",icon:"browse",onAction:async function(){if(await t("google")){confirm("You are signed in to Google Drive. Sign out?")&&(window.location.href=window.cloudProviders.google.logoutUrl)}else n("google")}}),o.on("init",async function(){gapi.load("client:picker",async()=>{const o=await fetch("/api/google/token"),e=await o.json();window.cloudProviders.google.token=e.token,window.cloudProviders.google.apiKey=e.api_key,window.cloudProviders.google.authenticated=e.authenticated||!1,await gapi.client.init({apiKey:e.api_key,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]}),e.token&&gapi.client.setToken({access_token:e.token})}),async function(){try{const o=await fetch("/api/onedrive/token"),e=await o.json();window.cloudProviders.onedrive.token=e.token,window.cloudProviders.onedrive.authenticated=e.authenticated||!1,console.log("OneDrive initialized:",e.authenticated?"Authenticated":"Not authenticated")}catch(o){console.error("Error initializing OneDrive:",o),window.cloudProviders.onedrive.authenticated=!1,window.cloudProviders.onedrive.token=null}}()}),{getMetadata:function(){return{name:"Cloud Sign-In Manager",url:"http://yoursite.com"}}}});