tinymce.PluginManager.add("cloudsignin",function(e,o){async function n(e){try{const o=await fetch(window.cloudProviders[e].tokenUrl),n=await o.json();return window.cloudProviders[e].authenticated=n.authenticated||!1,window.cloudProviders[e].token=n.token||null,window.cloudProviders[e].apiKey=n.api_key||null,n.authenticated}catch(e){return console.error("Error checking authentication:",e),!1}}function t(o,n){const t=window.cloudProviders[o],i={title:"Sign In Required",body:{type:"panel",items:[{type:"htmlpanel",html:`\n                            <div style="text-align: center; padding: 20px;">\n                                <div style="font-size: 48px; margin-bottom: 20px;">\n                                    ${t.icon}\n                                </div>\n                            </div>\n                        `}]},buttons:[{type:"cancel",text:"Cancel"},{type:"custom",text:"Sign In with "+t.name,name:"signin",primary:!0}],onAction:function(t,i){"signin"===i.name&&(t.close(),function(o,n){const t=window.cloudProviders[o];window.pendingAuthCallback=n;const i=(screen.width-600)/2,a=(screen.height-700)/2;window.open(t.authUrl,"CloudAuth",`width=600,height=700,left=${i},top=${a},toolbar=no,location=no,status=no,menubar=no,scrollbars=yes,resizable=yes`)||e.notificationManager.open({text:"Popup blocked! Please allow popups for this site.",type:"error",timeout:5e3})}(o,n))}};e.windowManager.open(i)}return window.cloudProviders={google:{name:"Google Drive",icon:'<img src="https://www.gstatic.com/images/branding/product/2x/drive_2020q4_64dp.png" alt="Google Drive" style="width: 128px; height: 128px;">',authUrl:"/auth/google",tokenUrl:"/api/google/token",logoutUrl:"/auth/google/logout",authenticated:!1,token:null},dropbox:{name:"Dropbox",icon:"ðŸ“¦",authUrl:"/auth/dropbox",tokenUrl:"/api/dropbox/token",logoutUrl:"/auth/dropbox/logout",authenticated:!1,token:null},onedrive:{name:"OneDrive",icon:'<img src="https://static2.sharepointonline.com/files/fabric/assets/brand-icons/product/svg/onedrive_48x1.svg" alt="OneDrive" style="width: 128px; height: 128px;">',authUrl:"/auth/onedrive",tokenUrl:"/api/onedrive/token",logoutUrl:"/auth/onedrive/logout",authenticated:!1,token:null}},window.addEventListener("message",async function(o){"google-auth-success"===o.data.type?(e.notificationManager.open({text:"Successfully signed in to Google Drive!",type:"success",timeout:3e3}),await n("google"),window.pendingAuthCallback&&(window.pendingAuthCallback(window.cloudProviders.google),window.pendingAuthCallback=null)):"onedrive-auth-success"===o.data.type?(e.notificationManager.open({text:"Successfully signed in to OneDrive!",type:"success",timeout:3e3}),await n("onedrive"),window.pendingAuthCallback&&(window.pendingAuthCallback(window.cloudProviders.onedrive),window.pendingAuthCallback=null)):("google-auth-error"===o.data.type||"onedrive-auth-error"===o.data.type)&&e.notificationManager.open({text:"Authentication failed: "+o.data.error,type:"error",timeout:5e3})}),window.requireCloudAuth=async function(e,o){return await n(e)?(o&&o(window.cloudProviders[e]),!0):(t(e,o),!1)},e.ui.registry.addButton("googlesignin",{text:"Google Drive",icon:"browse",onAction:async function(){if(await n("google")){confirm("You are signed in to Google Drive. Sign out?")&&(window.location.href=window.cloudProviders.google.logoutUrl)}else t("google")}}),e.on("init",async function(){gapi.load("client:picker",async()=>{const e=await fetch("/api/google/token"),o=await e.json();window.cloudProviders.google.token=o.token,window.cloudProviders.google.apiKey=o.api_key,window.cloudProviders.google.authenticated=o.authenticated||!1,await gapi.client.init({apiKey:o.api_key,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]}),o.token&&gapi.client.setToken({access_token:o.token})}),async function(){try{const e=await fetch("/api/onedrive/token"),o=await e.json();window.cloudProviders.onedrive.token=o.token,window.cloudProviders.onedrive.authenticated=o.authenticated||!1}catch(e){console.error("Error initializing OneDrive:",e),window.cloudProviders.onedrive.authenticated=!1,window.cloudProviders.onedrive.token=null}}()}),{getMetadata:function(){return{name:"Cloud Sign-In Manager",url:"http://yoursite.com"}}}});