!function(){"use strict";var t,e=tinymce.util.Tools.resolve("tinymce.PluginManager");"function"!=typeof Array.prototype.forEach&&(Array.prototype.forEach=function(t){for(var e=0;e<this.length;e++)t.apply(this,[this[e],e,this])}),Object.defineProperty&&Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(Element.prototype,"textContent")&&!Object.getOwnPropertyDescriptor(Element.prototype,"textContent").get&&(t=Object.getOwnPropertyDescriptor(Element.prototype,"innerText"),Object.defineProperty(Element.prototype,"textContent",{get:function(){return t.get.call(this)},set:function(e){return t.set.call(this,e)}}));var n=function(t,e){var n=t;for(var o in e)n=n.replace(/\{(\/?[^\}]+)\}/gm,e[o]);return n},o=function(t){var e=t.selection.getNode(),o="",r="SPAN"==e.tagName&&"fnoteWrap"===t.dom.getAttrib(e,"class"),i="fnoteWrap"==e.className?e.childNodes[0].firstChild.nodeValue.replace(/[^0-9]/g,""):e.childNodes[0];r&&(o=e.name||decodeURIComponent(e.childNodes[0].getAttribute("data-content"))||""),t.windowManager.open({title:"Insert/Edit Contents",size:"normal",body:{type:"panel",items:[{type:"textarea",name:"name",multiline:!0,minWidth:520,minHeight:100}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],initialData:{name:o},onSubmit:function(o){var a,c=o.getData().name,l=encodeURIComponent(c),s='<span class="fnoteWrap" id="#wk_ft{FOOTNOTE_INDEX}" contenteditable="false"><button type="button" class="fnoteBtn" data-content="'+l+'" title="'+decodeURIComponent(l).replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")+'">{FOOTNOTE_INDEX}</button></span>',f=t.getDoc().querySelectorAll(".fnoteBtn"),u=f.length;if(r&&e)return e.querySelector(".fnoteBtn").setAttribute("data-content",l),void o.close();var p,d,m,g=(p=t.selection.getNode(),d=function(t){var e=!1;return(e=[].filter.call(t.parentNode.children,(function(n){return n.previousElementSibling===t?e=!0:e}))).map((e=>Array.from(e.querySelectorAll("fnoteBtn").length)>0?p.nextElementSibling.classList.contains("fnoteBtn")?p.nextElementSibling.children.children:e.querySelectorAll(".fnoteBtn"):"BODY"===t.nodeName?[]:d(t.parentNode)))},m=function(t,e){if(!e)return!1;if(e)return p;var n=null;return e.children.forEach((function(){e&&(n=m(t,this))})),n},function(t,e){for(var n=d(e);0!==n.length;){var o=m(t,n);if(null!==o)return o;n=d(n)}return n}(".fnoteBtn",p));if(g.length){var y;for(g=g[0],y=0;y<u&&g!=f[y];y++);i<u?a=n(s,{FOOTNOTE_INDEX:$(f[i-1]).html()}):(a=n(s,{FOOTNOTE_INDEX:$(f[y]).html()}),t.selection.collapse(0))}else a=n(s,{FOOTNOTE_INDEX:u+1}),t.selection.collapse(0);t.execCommand("mceInsertContent",!1,a),o.close(),Array.from(t.getDoc().querySelectorAll(".fnoteBtn")).forEach((function(t,e){t.textContent=e+1,t.parentNode.setAttribute("id","#wk_ft"+(e+1))}))}})},r=function(t){t.addCommand("footnotes",(function(){o(t)}))},i=function(t){t.ui.registry.addToggleButton("footnotes",{icon:"fnote",tooltip:"Footnote",onAction:function(){return t.execCommand("footnotes")},onSetup:function(e){return t.selection.selectorChangedWithUnbind("span.fnoteWrap",e.setActive).unbind}}),t.ui.registry.addMenuItem("footnotes",{icon:"fnote",onAction:function(){return t.execCommand("footnotes")}})};e.add("footnotes",(function(t){t.ui.registry.addIcon("fnote",'<img src="'+tinyMCE.baseURL+'/plugins/footnotes/img/fn.png">'),r(t),i(t)}))}();