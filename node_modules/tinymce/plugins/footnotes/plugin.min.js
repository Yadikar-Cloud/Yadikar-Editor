!function(){"use strict";var t,e=tinymce.util.Tools.resolve("tinymce.PluginManager");"function"!=typeof Array.prototype.forEach&&(Array.prototype.forEach=function(t){for(var e=0;e<this.length;e++)t.apply(this,[this[e],e,this])}),Object.defineProperty&&Object.getOwnPropertyDescriptor&&Object.getOwnPropertyDescriptor(Element.prototype,"textContent")&&!Object.getOwnPropertyDescriptor(Element.prototype,"textContent").get&&(t=Object.getOwnPropertyDescriptor(Element.prototype,"innerText"),Object.defineProperty(Element.prototype,"textContent",{get:function(){return t.get.call(this)},set:function(e){return t.set.call(this,e)}}));var n=function(t,e){var n=t;for(var o in e)n=n.replace(/\{(\/?[^\}]+)\}/gm,e[o]);return n},o=function(t){var e=t.selection.getNode(),o="",r="SPAN"==e.tagName&&"fnoteWrap"===t.dom.getAttrib(e,"class"),i="fnoteWrap"==e.className?e.childNodes[0].firstChild.nodeValue.replace(/[^0-9]/g,""):e.childNodes[0];r&&(o=e.name||decodeURIComponent(e.childNodes[0].getAttribute("data-content"))||""),t.windowManager.open({title:"Insert/Edit Contents",size:"normal",body:{type:"panel",items:[{type:"textarea",name:"name",multiline:!0,minWidth:520,minHeight:100}]},buttons:[{type:"cancel",name:"cancel",text:"Cancel"},{type:"submit",name:"save",text:"Save",primary:!0}],initialData:{name:o},onSubmit:function(e){var o,r=e.getData().name,a=encodeURIComponent(r),c='<span class="fnoteWrap" id="#wk_ft{FOOTNOTE_INDEX}" contenteditable="false"><button type="button" class="fnoteBtn" data-content="'+a+'" title="'+decodeURIComponent(a).replace(/"/g,"&quot;").replace(/</g,"&lt;").replace(/>/g,"&gt;")+'">{FOOTNOTE_INDEX}</button></span>',l=t.getDoc().querySelectorAll(".fnoteBtn"),s=l.length;var f,u,p,d=(f=t.selection.getNode(),u=function(t){var e=!1;return(e=[].filter.call(t.parentNode.children,(function(n){return n.previousElementSibling===t?e=!0:e}))).map((e=>Array.from(e.querySelectorAll("fnoteBtn").length)>0?f.nextElementSibling.classList.contains("fnoteBtn")?f.nextElementSibling.children.children:e.querySelectorAll(".fnoteBtn"):"BODY"===t.nodeName?[]:u(t.parentNode)))},p=function(t,e){if(!e)return!1;if(e)return f;var n=null;return e.children.forEach((function(){e&&(n=p(t,this))})),n},function(t,e){for(var n=u(e);0!==n.length;){var o=p(t,n);if(null!==o)return o;n=u(n)}return n}(".fnoteBtn",f));if(d.length){var m;for(d=d[0],m=0;m<s&&d!=l[m];m++);i<s?o=n(c,{FOOTNOTE_INDEX:$(l[i-1]).html()}):(o=n(c,{FOOTNOTE_INDEX:$(l[m]).html()}),t.selection.collapse(0))}else o=n(c,{FOOTNOTE_INDEX:s+1}),t.selection.collapse(0);t.execCommand("mceInsertContent",!1,o),e.close(),Array.from(t.getDoc().querySelectorAll(".fnoteBtn")).forEach((function(t,e){t.textContent=e+1,t.parentNode.setAttribute("id","#wk_ft"+(e+1))}))}})},r=function(t){t.addCommand("footnotes",(function(){o(t)}))},i=function(t){t.ui.registry.addToggleButton("footnotes",{icon:"fnote",tooltip:"Footnote",onAction:function(){return t.execCommand("footnotes")},onSetup:function(e){return t.selection.selectorChangedWithUnbind("span.fnoteWrap",e.setActive).unbind}}),t.ui.registry.addMenuItem("footnotes",{icon:"fnote",onAction:function(){return t.execCommand("footnotes")}})};e.add("footnotes",(function(t){t.ui.registry.addIcon("fnote",'<img src="'+tinyMCE.baseURL+'/plugins/footnotes/img/fn.png">'),r(t),i(t)}))}();