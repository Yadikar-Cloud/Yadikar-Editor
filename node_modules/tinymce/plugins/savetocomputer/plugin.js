tinymce.PluginManager.add('savetocomputer', function(editor, url) {
    
    // Add button to toolbar
    editor.ui.registry.addButton('savetocomputer', {
        text: 'Save File',
        onAction: function() {
            saveFile();
        }
    });

    // Add menu item
    editor.ui.registry.addMenuItem('savetocomputer', {
        text: 'Local Device',
        onAction: function() {
            saveFile();
        }
    });

    editor.ui.registry.addMenuItem('sharefile', {
        text: 'Share the document',
        icon: 'export',
        onAction: function() {
            shareFile();
        }
    });
    
	async function saveFile() {
		try {
		    if (!window.showSaveFilePicker) {
		        downloadFile();
		        return;
		    }

		    const options = {
		        suggestedName: 'document.html',
		        types: window.getFilePickerTypes(),
		        excludeAcceptAllOption: true
		    };

		    const handle = await window.showSaveFilePicker(options);
		    const writable = await handle.createWritable();
		    
		    // Get selected extension from filename
		    const fileName = handle.name;
		    const extension = fileName.substring(fileName.lastIndexOf('.'));
		    
		    // Convert content
		    const htmlContent = editor.getContent()+'\n';
			const script = "<script>const filePath = window.location.href;window.location = '" + window.location.origin + "/editor?q=openfile&file=' + encodeURIComponent(filePath)</script>";
			const allcontent = htmlContent + script;
		    let content;
		    
		    try {
		        content = await window.fileConverter.convert(allcontent, extension);
		    } catch (error) {
		        editor.notificationManager.open({
		            text: 'Conversion failed: ' + error.message,
		            type: 'error',
		            timeout: 5000
		        });
		        return;
		    }
		    
		    // Handle blob or text
		    if (content instanceof Blob) {
		        await writable.write(content);
		    } else {
		        await writable.write(content);
		    }
		    
		    await writable.close();

		    window.currentLocalFile = {
		        handle: handle,
		        name: handle.name
		    };

		    editor.notificationManager.open({
		        text: 'Saved: ' + handle.name,
		        type: 'success',
		        timeout: 3000
		    });

		} catch (error) {
		    if (error.name !== 'AbortError') {
		        console.error('Error saving file:', error);
		        editor.notificationManager.open({
		            text: 'Failed to save file: ' + error.message,
		            type: 'error',
		            timeout: 5000
		        });
		    }
		}
	}

    // Fallback download method for unsupported browsers
	function downloadFile() {
		const content = editor.getContent()+'\n';
		const script = "<script>const filePath = window.location.href;window.location = `${window.location.origin}?q=openfile&file=${encodeURIComponent(filePath)}</script>`;"
		const allcontent = content + script;
		const blob = new Blob([allcontent], { type: 'text/html' });
		const url = URL.createObjectURL(blob);
		const a = document.createElement('a');
		a.href = url;
		a.download = 'document.html';
		document.body.appendChild(a);
		a.click();
		document.body.removeChild(a);
		URL.revokeObjectURL(url);

		editor.notificationManager.open({
		    text: 'File downloaded',
		    type: 'success',
		    timeout: 3000
		});
	}

	async function shareFile() {
		// Check if sharing files is supported
		if (navigator.canShare) {
			// Create file content
			const content = editor.getContent()+'\n';
			const script = "<script>const filePath = window.location.href;window.location = `${window.location.origin}?q=openfile&file=${encodeURIComponent(filePath)}</script>`;"
			const allcontent = content + script;
			const blob = new Blob([allcontent], { type: 'text/html' });		

			// Create a File object
			const file = new File([blob], "document.html", {
				type: "text/html",
				lastModified: new Date().getTime()
			});		
			try {
			  await navigator.share({
				title: "My Shared File",
				text: "Check out this document!",
				files: [file]
			  });
			  console.log("File shared successfully");
			} catch (err) {
			  console.error("Share failed:", err.message);
			}
		} else {
			console.log("File sharing not supported");
		}	
	}
	
    return {
        getMetadata: function() {
            return {
                name: 'Save to Computer',
                url: 'http://yoursite.com'
            };
        }
    };
});
