tinymce.PluginManager.add("savetogdrive",function(e,t){async function n(){let e=!1;await window.requireCloudAuth("google",function(t){i(t),e=!0})&&!e&&i(window.cloudProviders.google)}function i(t){window.openFolderInSaveDialog&&delete window.openFolderInSaveDialog,window.navigateToBreadcrumb&&delete window.navigateToBreadcrumb;let n="root",i=[{id:"root",name:"My Drive"}],o="root",a=null;const d={title:"Save to Google Drive",size:"medium",body:{type:"panel",items:[{type:"htmlpanel",html:`\n\t\t                    <div id="save-dialog-container" style="min-height: auto !important;">\n\t\t                        <div id="breadcrumb" style="padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-size: 13px;">\n\t\t                            <span>üìÅ My Drive</span>\n\t\t                        </div>\n\t\t                        <div id="folder-list" style="padding: 10px; max-height: 360px; overflow-y: auto; border-bottom: 1px solid #ddd;">\n\t\t                            <div style="text-align: center; padding: 20px; color: #666;">\n\t\t                                Loading folders...\n\t\t                            </div>\n\t\t                        </div>\n\t\t                        <div style="padding: 15px; background: #f9f9f9;">\n\t\t                            \x3c!-- File Name Row --\x3e\n\t\t                            <div style="display: flex; align-items: center; margin-bottom: 10px;">\n\t\t                                <label for="save-filename" style="width: 90px; font-weight: bold;">\n\t\t                                    File Name:\n\t\t                                </label>\n\t\t                                <input type="text" id="save-filename" value="Untitled" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">\n\t\t                            </div>\n\t\t                            \x3c!-- File Type Row --\x3e\n\t\t                            <div style="display: flex; align-items: center;">\n\t\t                                <label for="save-extension" style="width: 90px; font-weight: bold;">\n\t\t                                    File type:\n\t\t                                </label>\n\t\t                                <select id="save-extension" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">\n\t\t                                    ${window.getSelectOptions().map(e=>`<option value="${e.value}">${e.text}</option>`).join("")}\n\t\t                                </select>\n\t\t                            </div>\n\t\t                        </div>\n\t\t                    </div>\n\t\t                `}]},buttons:[{type:"cancel",text:"Cancel"},{type:"submit",text:"Save",primary:!0}],onSubmit:function(n){!async function(t,n,i){const o=document.getElementById("save-filename").value.trim(),a=document.getElementById("save-extension").value;if(!o)return void e.notificationManager.open({text:"Please enter a file name",type:"error",timeout:3e3});const d=o+a,r=e.getContent();i.close(),e.notificationManager.open({text:"Converting and saving to Google Drive...",type:"info"});try{let i;try{i=await window.fileConverter.convert(r,a)}catch(t){return void e.notificationManager.open({text:"Conversion failed: "+t.message,type:"error",timeout:5e3})}const o={name:d,parents:[n],mimeType:window.getMimeType(a)};let l;l=i instanceof Blob?i:new Blob([i],{type:window.getMimeType(a)});const s=new FormData;s.append("metadata",new Blob([JSON.stringify(o)],{type:"application/json"})),s.append("file",l);const c=await fetch("https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart",{method:"POST",headers:{Authorization:"Bearer "+t.token},body:s});if(!c.ok){const e=await c.json();throw new Error(e.error.message||"Unknown error")}{const t=await c.json();window.currentGDriveFile={id:t.id,name:d},e.notificationManager.open({text:"‚úÖ Saved: "+d,type:"success",timeout:3e3})}}catch(t){console.error("Error saving file:",t),e.notificationManager.open({text:"Failed to save: "+t.message,type:"error",timeout:5e3})}}(t,o,n)},onClose:function(){window.openFolderInSaveDialog&&delete window.openFolderInSaveDialog,window.navigateToBreadcrumb&&delete window.navigateToBreadcrumb}};async function r(e,t){const n=document.getElementById("folder-list");if(n){n.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">Loading folders...</div>';try{gapi.client&&gapi.client.drive||await async function(e){gapi.client&&gapi.client.drive||await gapi.client.init({apiKey:e.apiKey,discoveryDocs:["https://www.googleapis.com/discovery/v1/apis/drive/v3/rest"]})}(e),gapi.client.setToken({access_token:e.token});const n=await gapi.client.drive.files.list({q:`'${t}' in parents and trashed=false`,fields:"files(id, name, mimeType)",orderBy:"name",pageSize:100});!function(e){const t=document.getElementById("folder-list");if(!t)return;if(0===e.length)return void(t.innerHTML='<div style="text-align: center; padding: 20px; color: #666;">No items in this location<br><small>You can still save the file here</small></div>');let n='<div style="display: flex; flex-direction: column; gap: 5px;">';e.forEach(e=>{const t="application/vnd.google-apps.folder"===e.mimeType,i=t?"üìÅ":"üìÑ",o=t?`window.openFolderInSaveDialog('${e.id}', '${e.name}')`:"";n+=`\n                    <div class="folder-item" data-id="${e.id}" data-name="${e.name}" \n                         style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"\n                         onmouseover="this.style.background='#f0f0f0'" \n                         onmouseout="this.style.background='white'"\n                         onclick="this.classList.toggle('selected'); this.style.background=this.classList.contains('selected')?'#e3f2fd':'#f0f0f0';"\n                         ondblclick="${o}">\n                        <span style="font-size: 24px;">${i}</span>\n                        <span>${e.name}</span>\n                    </div>\n                `}),n+="</div>",t.innerHTML=n,document.querySelectorAll(".folder-item").forEach(e=>{e.addEventListener("click",function(e){1===e.detail&&(document.querySelectorAll(".folder-item").forEach(e=>{e.classList.remove("selected"),e.style.background="white"}),this.classList.add("selected"),this.style.background="#e3f2fd",o=this.dataset.id,s())})})}(n.result.files||[])}catch(e){console.error("Error loading folders:",e),n.innerHTML=`<div style="text-align: center; padding: 20px; color: #ea4335;">Failed to load folders: ${e.message}</div>`}}}function l(){const e=document.getElementById("breadcrumb");if(!e)return;let t="<span>üìÅ</span> ";i.forEach((e,n)=>{n>0&&(t+=" / "),t+=`<a href="#" onclick="window.navigateToBreadcrumb(${n}); return false;" style="color: #1976d2; text-decoration: none;">${e.name}</a>`}),e.innerHTML=t}function s(){const e=document.getElementById("save-location");if(!e)return;const t=i.map(e=>e.name).join(" / ");e.textContent=t}a=e.windowManager.open(d),setTimeout(()=>{a&&r(t,n)},100),window.openFolderInSaveDialog=function(e,a){n=e,o=e,i.push({id:e,name:a}),l(),s(),r(t,e)},window.navigateToBreadcrumb=function(e){i=i.slice(0,e+1),n=i[e].id,o=n,l(),s(),r(t,n)}}return e.ui.registry.addButton("savetogdrive",{text:"Save to Drive",onAction:function(){n()}}),e.ui.registry.addMenuItem("savetogdrive",{text:"Google Drive",onAction:function(){n()}}),{getMetadata:function(){return{name:"Save to Google Drive",url:"http://yoursite.com"}}}});