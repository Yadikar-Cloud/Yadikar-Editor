tinymce.PluginManager.add('savetogdrive', function(editor, url) {
    
    editor.ui.registry.addButton('savetogdrive', {
        text: 'Save to Drive',
        onAction: function() {
            saveToGoogleDrive();
        }
    });

    editor.ui.registry.addMenuItem('savetogdrive', {
        text: 'Google Drive',
        onAction: function() {
            saveToGoogleDrive();
        }
    });

    async function saveToGoogleDrive() {
        let dialogShown = false;

        // Use the global authentication system
        const authenticated = await window.requireCloudAuth('google', function(provider) {
            // This callback runs after successful authentication
            showSaveDialog(provider);
            dialogShown = true;
        });

        // If already authenticated and callback didn't show the dialog, show it now
        if (authenticated && !dialogShown) {
            showSaveDialog(window.cloudProviders.google);
        }
    }

	function showSaveDialog(provider) {
		// Clean up any previous dialog state
		if (window.openFolderInSaveDialog) {
		    delete window.openFolderInSaveDialog;
		}
		if (window.navigateToBreadcrumb) {
		    delete window.navigateToBreadcrumb;
		}
		// Initialize folder navigation
		let currentFolderId = 'root';
		let folderStack = [{id: 'root', name: 'My Drive'}];
		let selectedFolderId = 'root';
		let dialogInstance = null;
		
		// Build file type options dynamically
		const fileTypeOptions = window.getSelectOptions()
		    .map(opt => `<option value="${opt.value}">${opt.text}</option>`)
		    .join('');
		
		const dialogConfig = {
		    title: 'Save to Google Drive',
		    size: 'medium',
		    body: {
		        type: 'panel',
		        items: [
		            {
		                type: 'htmlpanel',
		                html: `
		                    <div id="save-dialog-container" style="min-height: auto !important;">
		                        <div id="breadcrumb" style="padding: 10px; background: #f5f5f5; border-bottom: 1px solid #ddd; font-size: 13px;">
		                            <span>üìÅ My Drive</span>
		                        </div>
		                        <div id="folder-list" style="padding: 10px; max-height: 360px; overflow-y: auto; border-bottom: 1px solid #ddd;">
		                            <div style="text-align: center; padding: 20px; color: #666;">
		                                Loading folders...
		                            </div>
		                        </div>
		                        <div style="padding: 15px; background: #f9f9f9;">
		                            <!-- File Name Row -->
		                            <div style="display: flex; align-items: center; margin-bottom: 10px;">
		                                <label for="save-filename" style="width: 90px; font-weight: bold;">
		                                    File Name:
		                                </label>
		                                <input type="text" id="save-filename" value="Untitled" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
		                            </div>
		                            <!-- File Type Row -->
		                            <div style="display: flex; align-items: center;">
		                                <label for="save-extension" style="width: 90px; font-weight: bold;">
		                                    File type:
		                                </label>
		                                <select id="save-extension" style="flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 4px;">
		                                    ${fileTypeOptions}
		                                </select>
		                            </div>
		                        </div>
		                    </div>
		                `
		            }
		        ]
		    },
		    buttons: [
		        {
		            type: 'cancel',
		            text: 'Cancel'
		        },
		        {
		            type: 'submit',
		            text: 'Save',
		            primary: true
		        }
		    ],
		    onSubmit: function(api) {
		        performSave(provider, selectedFolderId, api);
		    },
		    onClose: function() {
		        // Clean up when dialog closes
		        if (window.openFolderInSaveDialog) {
		            delete window.openFolderInSaveDialog;
		        }
		        if (window.navigateToBreadcrumb) {
		            delete window.navigateToBreadcrumb;
		        }
		    }
		};

        dialogInstance = editor.windowManager.open(dialogConfig);

        // Load folders after dialog opens
        setTimeout(() => {
            // Only load if dialog is still open
            if (dialogInstance) {
                loadFolders(provider, currentFolderId);
            }
        }, 100);

        // Helper function to load folders
        async function loadFolders(provider, folderId) {
            const folderListEl = document.getElementById('folder-list');
            if (!folderListEl) return;

            folderListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">Loading folders...</div>';

            try {
                // Set token
                if (!gapi.client || !gapi.client.drive) {
                    await initGapi(provider);
                }

                gapi.client.setToken({ access_token: provider.token });

                const response = await gapi.client.drive.files.list({
                    q: `'${folderId}' in parents and trashed=false`,
                    fields: 'files(id, name, mimeType)',
                    orderBy: 'name',
                    pageSize: 100
                });

                const folders = response.result.files || [];
                renderFolders(folders);

            } catch (error) {
                console.error('Error loading folders:', error);
                folderListEl.innerHTML = `<div style="text-align: center; padding: 20px; color: #ea4335;">Failed to load folders: ${error.message}</div>`;
            }
        }

        function renderFolders(folders) {
            const folderListEl = document.getElementById('folder-list');
            if (!folderListEl) return;

            if (folders.length === 0) {
                folderListEl.innerHTML = '<div style="text-align: center; padding: 20px; color: #666;">No items in this location<br><small>You can still save the file here</small></div>';
                return;
            }

            let html = '<div style="display: flex; flex-direction: column; gap: 5px;">';
            folders.forEach(item => {
                const isFolder = item.mimeType === 'application/vnd.google-apps.folder';
                const icon = isFolder ? 'üìÅ' : 'üìÑ';
                const ondblclick = isFolder ? `window.openFolderInSaveDialog('${item.id}', '${item.name}')` : '';
                
                html += `
                    <div class="folder-item" data-id="${item.id}" data-name="${item.name}" 
                         style="padding: 10px; border: 1px solid #ddd; border-radius: 4px; cursor: pointer; display: flex; align-items: center; gap: 10px; transition: background 0.2s;"
                         onmouseover="this.style.background='#f0f0f0'" 
                         onmouseout="this.style.background='white'"
                         onclick="this.classList.toggle('selected'); this.style.background=this.classList.contains('selected')?'#e3f2fd':'#f0f0f0';"
                         ondblclick="${ondblclick}">
                        <span style="font-size: 24px;">${icon}</span>
                        <span>${item.name}</span>
                    </div>
                `;
            });
            html += '</div>';

            folderListEl.innerHTML = html;

            // Add click handlers
            document.querySelectorAll('.folder-item').forEach(item => {
                item.addEventListener('click', function(e) {
                    if (e.detail === 1) { // Single click
                        document.querySelectorAll('.folder-item').forEach(el => {
                            el.classList.remove('selected');
                            el.style.background = 'white';
                        });
                        this.classList.add('selected');
                        this.style.background = '#e3f2fd';
                        selectedFolderId = this.dataset.id;
                        updateSaveLocation();
                    }
                });
            });
        }

        // Global function for double-click to open folder
        window.openFolderInSaveDialog = function(folderId, folderName) {
            currentFolderId = folderId;
            selectedFolderId = folderId;
            folderStack.push({id: folderId, name: folderName});
            updateBreadcrumb();
            updateSaveLocation();
            loadFolders(provider, folderId);
        };

        function updateBreadcrumb() {
            const breadcrumbEl = document.getElementById('breadcrumb');
            if (!breadcrumbEl) return;

            let html = '<span>üìÅ</span> ';
            folderStack.forEach((folder, index) => {
                if (index > 0) html += ' / ';
                html += `<a href="#" onclick="window.navigateToBreadcrumb(${index}); return false;" style="color: #1976d2; text-decoration: none;">${folder.name}</a>`;
            });

            breadcrumbEl.innerHTML = html;
        }

        window.navigateToBreadcrumb = function(index) {
            folderStack = folderStack.slice(0, index + 1);
            currentFolderId = folderStack[index].id;
            selectedFolderId = currentFolderId;
            updateBreadcrumb();
            updateSaveLocation();
            loadFolders(provider, currentFolderId);
        };

        function updateSaveLocation() {
            const locationEl = document.getElementById('save-location');
            if (!locationEl) return;

            const path = folderStack.map(f => f.name).join(' / ');
            locationEl.textContent = path;
        }
    }

    async function initGapi(provider) {
        if (!gapi.client || !gapi.client.drive) {
            await gapi.client.init({
                apiKey: provider.apiKey,
                discoveryDocs: ['https://www.googleapis.com/discovery/v1/apis/drive/v3/rest']
            });
        }
    }

	async function performSave(provider, folderId, dialogApi) {
		const fileName = document.getElementById('save-filename').value.trim();
		const extension = document.getElementById('save-extension').value;

		if (!fileName) {
		    editor.notificationManager.open({
		        text: 'Please enter a file name',
		        type: 'error',
		        timeout: 3000
		    });
		    return;
		}

		const fullFileName = fileName + extension;
		const htmlContent = editor.getContent();

		dialogApi.close();

		editor.notificationManager.open({
		    text: 'Converting and saving to Google Drive...',
		    type: 'info'
		});

		try {
		    // Convert content
		    let content;
		    try {
		        content = await window.fileConverter.convert(htmlContent, extension);
		    } catch (error) {
		        editor.notificationManager.open({
		            text: 'Conversion failed: ' + error.message,
		            type: 'error',
		            timeout: 5000
		        });
		        return;
		    }

		    // Prepare file metadata
		    const metadata = {
		        name: fullFileName,
		        parents: [folderId],
		        mimeType: window.getMimeType(extension)
		    };

		    // Create blob from content
		    let blob;
		    if (content instanceof Blob) {
		        blob = content;
		    } else {
		        blob = new Blob([content], { type: window.getMimeType(extension) });
		    }

		    // Upload file
		    const formData = new FormData();
		    formData.append('metadata', new Blob([JSON.stringify(metadata)], { type: 'application/json' }));
		    formData.append('file', blob);

		    const response = await fetch('https://www.googleapis.com/upload/drive/v3/files?uploadType=multipart', {
		        method: 'POST',
		        headers: {
		            'Authorization': 'Bearer ' + provider.token
		        },
		        body: formData
		    });

		    if (response.ok) {
		        const result = await response.json();
		        
		        window.currentGDriveFile = {
		            id: result.id,
		            name: fullFileName
		        };

		        editor.notificationManager.open({
		            text: '‚úÖ Saved: ' + fullFileName,
		            type: 'success',
		            timeout: 3000
		        });
		    } else {
		        const error = await response.json();
		        throw new Error(error.error.message || 'Unknown error');
		    }

		} catch (error) {
		    console.error('Error saving file:', error);
		    editor.notificationManager.open({
		        text: 'Failed to save: ' + error.message,
		        type: 'error',
		        timeout: 5000
		    });
		}
	}

    function getMimeType(extension) {
        const mimeTypes = {
            '.txt': 'text/plain',
            '.html': 'text/html',
            '.md': 'text/markdown',
            '.doc': 'application/msword'
        };
        return mimeTypes[extension] || 'text/plain';
    }

    return {
        getMetadata: function() {
            return {
                name: 'Save to Google Drive',
                url: 'http://yoursite.com'
            };
        }
    };
});
