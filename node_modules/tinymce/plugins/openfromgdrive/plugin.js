tinymce.PluginManager.add('openfromgdrive', function(editor, url) {
    let pickerOpen = false;
    
    editor.ui.registry.addButton('openfromgdrive', {
        text: 'Open from Drive',
        onAction: function() {
            openGoogleDrivePicker();
        }
    });

    editor.ui.registry.addMenuItem('openfromgdrive', {
        text: 'from Google Drive',
        onAction: function() {
            openGoogleDrivePicker();
        }
    });

    function restoreEditorFocus() {
        setTimeout(() => {
            editor.focus();
            editor.fire('focus');
        }, 0);
    }

    async function openGoogleDrivePicker() {
        // Prevent multiple pickers from opening
        if (pickerOpen) {
            return;
        }

        // Use the global authentication system
        let provider = null;
        
        // Try to use existing authentication
        if (window.cloudProviders && window.cloudProviders.google) {
            provider = window.cloudProviders.google;
        } else {
            // Otherwise authenticate
            provider = await window.requireCloudAuth('google');
        }

        // Load picker after authentication is confirmed
        if (provider) {
            loadGooglePicker(provider);
        }
    }

    function loadGooglePicker(provider) {
        // Ensure gapi is loaded
        if (typeof gapi === 'undefined') {
            editor.notificationManager.open({
                text: 'Google API is loading... Please try again.',
                type: 'info',
                timeout: 2000
            });
            return;
        }
        
        // Wait for gapi.client to be ready
        if (!gapi.client || !gapi.client.setToken) {
            editor.notificationManager.open({
                text: 'Google API not ready. Please wait and try again.',
                type: 'info',
                timeout: 2000
            });
            return;
        }
        
        // Set token
        gapi.client.setToken({ access_token: provider.token });

        // Load Google Picker
        gapi.load('picker', function() {
            pickerOpen = true;
            const picker = new google.picker.PickerBuilder()
                .addView(google.picker.ViewId.DOCS)
                .setOAuthToken(provider.token)
                .setDeveloperKey(provider.apiKey)
                .setCallback(pickerCallback)
                .setTitle('Open from Google Drive')
                .build();
            picker.setVisible(true);
        });
    }

    function pickerCallback(data) {
        if (data.action === google.picker.Action.PICKED) {
            const file = data.docs[0];
            loadFileContent(file.id, file.name);
            restoreEditorFocus();
        } 
        else if (data.action === google.picker.Action.CANCEL) {
            editor.notificationManager.open({
                text: 'Selection cancelled',
                type: 'info',
                timeout: 2000
            });
            restoreEditorFocus();
        }
        
        // Reset picker flag when closed
        pickerOpen = false;
    }


    async function loadFileContent(fileId, fileName) {
        editor.notificationManager.open({
            text: 'Loading file...',
            type: 'info'
        });

        try {
            const response = await gapi.client.drive.files.get({
                fileId: fileId,
                alt: 'media'
            });

            editor.setContent(response.body);
            
            window.currentGDriveFile = {
                id: fileId,
                name: fileName
            };

            editor.notificationManager.open({
                text: 'Opened: ' + fileName,
                type: 'success',
                timeout: 3000
            });

        } catch (error) {
            console.error('Error loading file:', error);
            editor.notificationManager.open({
                text: 'Failed to open file: ' + error.message,
                type: 'error',
                timeout: 5000
            });
        }
    }

    return {
        getMetadata: function() {
            return {
                name: 'Open from Google Drive',
                url: 'http://yoursite.com'
            };
        }
    };
});
