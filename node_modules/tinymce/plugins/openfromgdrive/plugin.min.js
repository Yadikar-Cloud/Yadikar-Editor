tinymce.PluginManager.add("openfromgdrive",function(e,t){let o=!1;function i(){setTimeout(()=>{e.focus(),e.fire("focus")},0)}async function n(){if(o)return;let e=!1;await window.requireCloudAuth("google",function(t){a(t),e=!0})&&!e&&a(window.cloudProviders.google)}function a(t){"undefined"!=typeof gapi?gapi.client&&gapi.client.setToken?(gapi.client.setToken({access_token:t.token}),gapi.load("picker",function(){o=!0;(new google.picker.PickerBuilder).addView(google.picker.ViewId.DOCS).setOAuthToken(t.token).setDeveloperKey(t.apiKey).setCallback(r).setTitle("Open from Google Drive").build().setVisible(!0)})):e.notificationManager.open({text:"Google API not ready. Please wait and try again.",type:"info",timeout:2e3}):e.notificationManager.open({text:"Google API is loading... Please try again.",type:"info",timeout:2e3})}function r(t){if(t.action===google.picker.Action.PICKED){const o=t.docs[0];!async function(t,o){try{const i=o.substring(o.lastIndexOf(".")).toLowerCase();if(".html"===i){const o=await gapi.client.drive.files.get({fileId:t,alt:"media"});e.setContent(o.body)}else{if(".docx"===i){const e=gapi.auth.getToken().access_token,o=await fetch(`https://www.googleapis.com/drive/v3/files/${t}?alt=media`,{headers:{Authorization:`Bearer ${e}`}});if(!o.ok)throw new Error("Failed to download file");const n=await o.blob();htmlContent=await window.fileConverter.convertToHtml(n,i)}else{const e=await gapi.client.drive.files.get({fileId:t,alt:"media"});htmlContent=await window.fileConverter.convertToHtml(e.body,i)}setTimeout(()=>{window.reapplyPageView&&window.reapplyPageView(htmlContent)},100)}window.currentGDriveFile={id:t,name:o},e.notificationManager.open({text:"Opened: "+o,type:"success",timeout:3e3})}catch(t){console.error("Error loading file:",t),e.notificationManager.open({text:"Failed to open file: "+t.message,type:"error",timeout:5e3})}}(o.id,o.name),i()}else t.action===google.picker.Action.CANCEL&&(e.notificationManager.open({text:"Selection cancelled",type:"info",timeout:2e3}),i());o=!1}return e.ui.registry.addButton("openfromgdrive",{text:"Open from Drive",onAction:function(){n()}}),e.ui.registry.addMenuItem("openfromgdrive",{text:"Google Drive",onAction:function(){n()}}),{getMetadata:function(){return{name:"Open from Google Drive",url:"http://yoursite.com"}}}});